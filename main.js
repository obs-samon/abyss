/*
Abyss - Thought Capture v2.1.0
i
*/

var G=Object.defineProperty;var rt=Object.getOwnPropertyDescriptor;var ot=Object.getOwnPropertyNames;var at=Object.prototype.hasOwnProperty;var lt=(d,s)=>{for(var t in s)G(d,t,{get:s[t],enumerable:!0})},ct=(d,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of ot(s))!at.call(d,i)&&i!==t&&G(d,i,{get:()=>s[i],enumerable:!(e=rt(s,i))||e.enumerable});return d};var ht=d=>ct(G({},"__esModule",{value:!0}),d);var ut={};lt(ut,{default:()=>z});module.exports=ht(ut);var S=require("obsidian");var g=class extends Error{constructor(t,e="UNKNOWN_ERROR",i){super(t);this.name="AbyssError",this.code=e,this.context=i}};function T(d){return{success:!0,data:d}}function I(d){return{success:!1,error:d}}var tt=Object.freeze({id:"Abyss-Thought-Capture",name:"Abyss - Thought Capture",version:"1.2.0",phase:"Phase 1.2"}),f=Object.freeze([{id:"standard",name:"\u30B9\u30BF\u30F3\u30C0\u30FC\u30C9",description:"\u6C4E\u7528\u7684\u306A\u512A\u5148\u5EA6\u30BB\u30C3\u30C8",priorities:Object.freeze([{symbol:"\u2705",label:"todo",description:"\u3084\u308B\u3053\u3068",showInAdventView:!0},{symbol:"\u{1F4A1}",label:"idea",description:"\u601D\u3044\u3064\u3044\u305F\u30A2\u30A4\u30C7\u30A2",showInAdventView:!0},{symbol:"\u2728",label:"done",description:"\u3084\u3063\u305F\u3053\u3068",showInAdventView:!1},{symbol:"\u{1F4AD}",label:"thought",description:"\u601D\u3063\u305F\u3053\u3068",showInAdventView:!1},{symbol:"\u{1F6D2}",label:"wishlist",description:"\u8CB7\u3044\u305F\u3044\u3082\u306E",showInAdventView:!0},{symbol:"\u{1F4CC}",label:"note",description:"\u899A\u3048\u3066\u304A\u304D\u305F\u3044\u3053\u3068",showInAdventView:!0}])}]),b=Object.freeze({symbol:"\u2795",label:"more",description:"\u76F4\u524D\u306E\u601D\u8003\u306B\u8FFD\u8A18"}),dt="Abyss",P="Abyss/Advent log.md",mt=Object.freeze({thoughtLogPath:"01-\u5165\u529B\u30A8\u30EA\u30A2",deepDiveFolder:"02-\u6DF1\u5800\u308A\u30CE\u30FC\u30C8",reviewFolder:"04-\u30EC\u30D3\u30E5\u30FC"});var et=Object.freeze([dt]),v=Object.freeze({showNotifications:!0,foldersInitialized:!1,selectedPreset:"standard",priorities:[...f[0].priorities],autoOpenAdventLog:!0,logArchiveAsDone:!0,doneLogTemplate:"{emoji}\u300C{content}\u300D\u3092\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002"}),w=Object.freeze({maxContentLength:100,maxPrioritiesDisplay:9,maxCustomPriorities:8}),K=Object.freeze({capture:{modifiers:["Mod","Shift"],key:"t"}}),p=Object.freeze({success:{thoughtSaved:"\u601D\u8003\u3092\u4FDD\u5B58\u3057\u307E\u3057\u305F",thoughtContinued:"\u524D\u306E\u601D\u8003\u306B\u8FFD\u8A18\u3057\u307E\u3057\u305F",foldersCreated:"\u30D5\u30A9\u30EB\u30C0\u69CB\u9020\u3092\u4F5C\u6210\u3057\u307E\u3057\u305F",priorityAdded:"\u512A\u5148\u5EA6\u3092\u8FFD\u52A0\u3057\u307E\u3057\u305F",priorityDeleted:"\u512A\u5148\u5EA6\u3092\u524A\u9664\u3057\u307E\u3057\u305F"},error:{folderCreation:"\u30D5\u30A9\u30EB\u30C0\u306E\u4F5C\u6210\u306B\u5931\u6557\u3057\u307E\u3057\u305F",fileSave:"\u601D\u8003\u306E\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F",settingsLoad:"\u8A2D\u5B9A\u306E\u8AAD\u307F\u8FBC\u307F\u306B\u5931\u6557\u3057\u307E\u3057\u305F",emptyContent:"\u601D\u8003\u5185\u5BB9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044",contentTooLong:"\u601D\u8003\u5185\u5BB9\u306F100\u6587\u5B57\u4EE5\u5185\u3067\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044",noPreviousThought:"\u8FFD\u8A18\u3059\u308B\u524D\u306E\u601D\u8003\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3067\u3057\u305F"}}),m=Object.freeze({modal:Object.freeze({container:"instant-deep-thinking-modal-container",modal:"instant-deep-thinking-modal",contextContainer:"context-container",contextGrid:"context-grid",contextButton:"context-button",priorityButton:"priority-button",thoughtInput:"thought-input",charCounter:"char-counter",saveButton:"save-button",backButton:"back-button"}),settings:Object.freeze({container:"abyss-settings",section:"abyss-settings-section",contextItem:"context-item"})}),W=Object.freeze({maxContentLength:w.maxContentLength,maxLabelLength:30,forbiddenChars:/[<>:"|?*\\\/]/}),yt=Object.freeze({weekdays:["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"]});var E=require("obsidian");var N=class{constructor(s,t=!0){this.prefix=`[${s}]`,this.enabled=t}debug(s,...t){this.log("debug",s,...t)}info(s,...t){this.log("info",s,...t)}warn(s,...t){this.log("warn",s,...t)}error(s,...t){this.log("error",s,...t)}logError(s,t){let e=t?` [${t}]`:"";this.error(`${e} ${s.message}`,{stack:s.stack})}log(s,t,...e){if(!this.enabled)return;let i=new Date().toISOString(),n=`${this.prefix} [${i}] ${t}`;switch(s){case"debug":console.debug(n,...e);break;case"info":console.info(n,...e);break;case"warn":console.warn(n,...e);break;case"error":console.error(n,...e);break}}},C=class{validateSettings(s){let t=s||{};return typeof t.showNotifications!="boolean"&&(t.showNotifications=v.showNotifications),typeof t.foldersInitialized!="boolean"&&(t.foldersInitialized=v.foldersInitialized),typeof t.autoOpenAdventLog!="boolean"&&(t.autoOpenAdventLog=v.autoOpenAdventLog),typeof t.logArchiveAsDone!="boolean"&&(t.logArchiveAsDone=v.logArchiveAsDone),typeof t.selectedPreset!="string"&&(t.selectedPreset=v.selectedPreset),!Array.isArray(t.priorities)||t.priorities.length===0?t.priorities=[...v.priorities]:t.priorities=this.validatePriorities(t.priorities),t}validatePriorities(s){var e;let t=[];for(let i of s)try{this.validatePriority(i),t.push({symbol:i.symbol.trim(),label:i.label.trim(),description:((e=i.description)==null?void 0:e.trim())||"",showInAdventView:i.showInAdventView!==!1})}catch(n){console.warn("Invalid priority found, skipping:",i)}return t.length>0?t:[...v.priorities]}validatePriority(s){if(!s||typeof s!="object")throw new g("\u512A\u5148\u5EA6\u304C\u4E0D\u6B63\u3067\u3059","INVALID_PRIORITY");if(!s.symbol||typeof s.symbol!="string"||s.symbol.trim()==="")throw new g("\u512A\u5148\u5EA6\u306E\u7D75\u6587\u5B57\u304C\u5FC5\u8981\u3067\u3059","INVALID_PRIORITY_SYMBOL");if(!s.label||typeof s.label!="string"||s.label.trim()==="")throw new g("\u512A\u5148\u5EA6\u306E\u30E9\u30D9\u30EB\u304C\u5FC5\u8981\u3067\u3059","INVALID_PRIORITY_LABEL");if(s.label.length>W.maxLabelLength)throw new g("\u512A\u5148\u5EA6\u306E\u30E9\u30D9\u30EB\u306F30\u6587\u5B57\u4EE5\u5185\u3067\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044","PRIORITY_LABEL_TOO_LONG")}validateThought(s){if(!s||typeof s!="object")throw new g("\u601D\u8003\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u304C\u4E0D\u6B63\u3067\u3059","INVALID_THOUGHT");if(!s.id||typeof s.id!="string")throw new g("\u601D\u8003ID\u304C\u4E0D\u6B63\u3067\u3059","INVALID_THOUGHT_ID");if(!s.content||typeof s.content!="string")throw new g("\u601D\u8003\u5185\u5BB9\u304C\u5165\u529B\u3055\u308C\u3066\u3044\u307E\u305B\u3093","EMPTY_THOUGHT_CONTENT");let t=s.content.trim();if(t==="")throw new g("\u601D\u8003\u5185\u5BB9\u304C\u7A7A\u3067\u3059","EMPTY_THOUGHT_CONTENT");if(t.length>W.maxContentLength)throw new g("\u601D\u8003\u5185\u5BB9\u306F100\u6587\u5B57\u4EE5\u5185\u3067\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044","THOUGHT_TOO_LONG");if(!(s.timestamp instanceof Date)||isNaN(s.timestamp.getTime()))throw new g("\u30BF\u30A4\u30E0\u30B9\u30BF\u30F3\u30D7\u304C\u4E0D\u6B63\u3067\u3059","INVALID_TIMESTAMP");if(s.isContinuation&&s.priority!==b.symbol)throw new g("\u4E0D\u6B63\u306A\u7D9A\u304D\u8A2D\u5B9A\u3067\u3059","INVALID_CONTINUATION")}validateFilePath(s){if(!s||typeof s!="string"||s.trim()==="")throw new g("\u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\u304C\u4E0D\u6B63\u3067\u3059","INVALID_FILE_PATH");if(/\.\./.test(s)||/^[\/\\]/.test(s)||/[<>:"|?*]/.test(s))throw new g("\u4E0D\u6B63\u306A\u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\u3067\u3059","DANGEROUS_FILE_PATH")}};function Y(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function J(d){let s=d.getFullYear(),t=String(d.getMonth()+1).padStart(2,"0"),e=String(d.getDate()).padStart(2,"0"),i=d.getDay(),n=["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"][i];return`${s}/${t}/${e} (${n})`}function X(d){let s=String(d.getHours()).padStart(2,"0"),t=String(d.getMinutes()).padStart(2,"0");return`${s}:${t}`}function it(d){let t=new Date().getTime()-d.getTime(),e=Math.floor(t/(1e3*60)),i=Math.floor(e/60),n=Math.floor(i/24);return e<1?"\u305F\u3063\u305F\u4ECA":e<60?`${e}\u5206\u524D`:i<24?`${i}\u6642\u9593\u524D`:n<7?`${n}\u65E5\u524D`:d.toLocaleDateString("ja-JP")}var _=class extends E.Modal{constructor(t,e,i){super(t);this.isProcessing=!1;this.contentInput=null;this.charCounter=null;this.currentKeyboardHandler=null;this.settings=e,this.callbacks=i,this.thought={id:Y(),timestamp:new Date},this.currentStep="priority"}onOpen(){this.modalEl.addClass(m.modal.container),this.contentEl.addClass(m.modal.modal),this.initializeFlow()}onClose(){this.cleanup()}initializeFlow(){switch(this.currentStep){case"priority":this.showPriorityStep();break;case"content":this.showContentStep();break}}showPriorityStep(){this.renderHeader("\u512A\u5148\u5EA6\u3092\u9078\u629E",1,2);let t=this.contentEl.createDiv("priorities-container");this.settings.priorities.forEach((e,i)=>{this.createPriorityButton(t,e,i+1)}),this.createContinuePriorityButton(t),this.setupKeyboardNavigation("priority")}createContinuePriorityButton(t){let e=t.createDiv(`${m.modal.priorityButton} priority-continue`);e.setAttribute("tabindex","0"),e.createSpan({text:b.symbol,cls:"priority-icon"});let i=e.createDiv("priority-text");i.createSpan({text:b.label,cls:"priority-label"}),i.createDiv({text:b.description,cls:"priority-description"}),e.createDiv("shortcut").setText("0"),e.addEventListener("click",()=>this.selectContinue())}selectContinue(){this.thought.priority=b.symbol,this.thought.isContinuation=!0,this.transitionToStep("content")}showContentStep(){this.renderHeader("\u601D\u8003\u3092\u5165\u529B",2,2),this.showSelectionSummary(),this.thought.isContinuation?this.showContinuationHint():this.showPriorityHint(),this.createInputField(),this.createButtons(),this.setupContentKeyboard(),setTimeout(()=>{var t;return(t=this.contentInput)==null?void 0:t.focus()},100)}createPriorityButton(t,e,i){let n=t.createDiv(m.modal.priorityButton);n.setAttribute("tabindex","0"),n.createSpan({text:e.symbol,cls:"priority-icon"});let r=n.createDiv("priority-text");r.createSpan({text:e.label,cls:"priority-label"}),e.description&&r.createDiv({text:e.description,cls:"priority-description"}),n.createDiv("shortcut").setText(`${i}`),n.addEventListener("click",()=>this.selectPriority(e.symbol))}showSelectionSummary(){let t=this.contentEl.createDiv("selection-info");this.thought.priority&&t.createSpan({text:this.thought.priority})}showContinuationHint(){let t=this.contentEl.createDiv("continuation-hint-container");t.createEl("h4",{text:"\u2795 more"}),t.createEl("p",{text:"\u76F4\u524D\u306E\u601D\u8003\u306B\u8FFD\u8A18\u3055\u308C\u307E\u3059\u3002\u95A2\u9023\u3059\u308B\u5185\u5BB9\u3092\u7D9A\u3051\u3066\u8A18\u9332\u3057\u307E\u3057\u3087\u3046\u3002"})}showPriorityHint(){let t=this.thought.priority;if(!t)return;let e=this.settings.priorities.find(n=>n.symbol===t);if(!e||!e.description)return;let i=this.contentEl.createDiv("priority-hint-container");i.createEl("h4",{text:`${t} ${e.label}`}),i.createEl("p",{text:e.description})}createInputField(){let t=this.contentEl.createDiv("input-container");this.contentInput=t.createEl("input",{type:"text",placeholder:"\u601D\u8003\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\uFF08100\u6587\u5B57\u4EE5\u5185\uFF09",cls:m.modal.thoughtInput}),this.contentInput.maxLength=w.maxContentLength,this.charCounter=t.createDiv(m.modal.charCounter),this.updateCharCounter(),this.contentInput.addEventListener("input",()=>{this.updateCharCounter()})}createButtons(){let t=this.contentEl.createDiv("button-container");t.createEl("button",{text:"\u4FDD\u5B58 (Ctrl+Enter)",cls:`${m.modal.saveButton} mod-cta`}).addEventListener("click",()=>this.saveThought()),t.createEl("button",{text:"\u7D9A\u3051\u3066\u601D\u8003 (Alt+Enter)",cls:`${m.modal.saveButton}`}).addEventListener("click",()=>this.continueThought())}async continueThought(){await this.saveThoughtCommon(()=>{this.settings.showNotifications&&new E.Notice("\u601D\u8003\u3092\u4FDD\u5B58\u3057\u307E\u3057\u305F\u3002\u7D9A\u3051\u3066\u5165\u529B\u3067\u304D\u307E\u3059\u3002"),this.thought={id:Y(),timestamp:new Date,priority:b.symbol,isContinuation:!0},this.transitionToStep("content")})}async saveThoughtCommon(t){if(!this.contentInput||this.isProcessing)return;let e=this.contentInput.value.trim();if(!e){new E.Notice(p.error.emptyContent);return}try{this.isProcessing=!0,this.thought.content=e,await this.callbacks.onThoughtSaved(this.thought),t()}catch(i){let n=i instanceof Error?i.message:String(i);new E.Notice(`\u601D\u8003\u306E\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F: ${n}`,6e3)}finally{this.isProcessing=!1}}updateCharCounter(){if(!this.charCounter||!this.contentInput)return;let t=this.contentInput.value.length,e=w.maxContentLength;this.charCounter.textContent=`${t}/${e}`,this.charCounter.className=m.modal.charCounter,t>e*.8&&this.charCounter.classList.add("char-counter-warning"),t>=e&&this.charCounter.classList.add("char-counter-error")}setupKeyboardNavigation(t){this.currentKeyboardHandler&&document.removeEventListener("keydown",this.currentKeyboardHandler);let e=i=>{if(!this.modalEl.isConnected)return;if(i.key==="Escape"){this.close();return}let n=i.target;if(n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"))return;let r=parseInt(i.key);if(!isNaN(r)){let o=!1;t==="priority"&&r>=0&&r<=9&&(o=!0,r===0?this.selectContinue():r<=this.settings.priorities.length&&this.selectPriority(this.settings.priorities[r-1].symbol)),o&&(i.preventDefault(),i.stopPropagation())}};this.currentKeyboardHandler=e,document.addEventListener("keydown",e)}setupContentKeyboard(){this.currentKeyboardHandler&&(this.contentEl.removeEventListener("keydown",this.currentKeyboardHandler),this.currentKeyboardHandler=null);let t=e=>{e.ctrlKey&&e.key==="Enter"?(e.preventDefault(),this.saveThought()):e.altKey&&e.key==="Enter"?(e.preventDefault(),this.continueThought()):e.key==="Escape"&&this.close()};this.currentKeyboardHandler=t,this.contentEl.addEventListener("keydown",t)}selectPriority(t){this.thought.priority=t,this.transitionToStep("content")}transitionToStep(t){this.cleanup(),this.currentStep=t,this.contentEl.empty(),this.initializeFlow()}async saveThought(){await this.saveThoughtCommon(()=>{if(this.settings.showNotifications){let t=this.thought.isContinuation?p.success.thoughtContinued:p.success.thoughtSaved;new E.Notice(t)}this.close()})}renderHeader(t,e,i){this.contentEl.empty();let n=this.contentEl.createDiv("modal-header");if(n.createEl("h2",{text:t}),e&&i){let r=n.createDiv("modal-progress");r.textContent=`${e}/${i}`}}cleanup(){this.currentKeyboardHandler&&(document.removeEventListener("keydown",this.currentKeyboardHandler),this.currentKeyboardHandler=null)}};var u=require("obsidian");var st=require("obsidian"),gt=Object.freeze([{name:"\u72B6\u614B\u30FB\u30A2\u30AF\u30B7\u30E7\u30F3",emojis:["\u2705","\u2728","\u{1F525}","\u26A1","\u{1F4A1}","\u{1F331}","\u{1F3AF}","\u{1F4CC}","\u2795","\u2714\uFE0F","\u{1F680}","\u2B50"]},{name:"\u601D\u8003\u30FB\u611F\u60C5",emojis:["\u{1F4AD}","\u2764\uFE0F","\u{1F60A}","\u{1F914}","\u{1F4AA}","\u{1F44D}","\u{1F64F}","\u{1F62E}","\u{1F389}","\u{1F496}"]},{name:"\u4ED5\u4E8B\u30FB\u5B66\u7FD2",emojis:["\u{1F4CB}","\u{1F4DD}","\u{1F4DA}","\u{1F91D}","\u{1F4BC}","\u{1F393}","\u{1F4CA}","\u{1F4BB}","\u{1F58A}\uFE0F","\u{1F4D6}","\u270F\uFE0F","\u{1F4C4}"]},{name:"\u751F\u6D3B",emojis:["\u{1F6D2}","\u{1F3C3}","\u{1F3AE}","\u{1F354}","\u{1F48A}","\u{1F3E0}","\u{1F697}","\u2708\uFE0F","\u{1F3B5}","\u{1F3A8}","\u{1F4F7}","\u26BD"]},{name:"\u8A18\u53F7",emojis:["\u2753","\u2757","\u26A0\uFE0F","\u{1F514}","\u{1F516}","\u{1F4CD}","\u{1F511}","\u{1F381}","\u{1F4AC}","\u{1F4E2}","\u{1F50D}"]}]),V=class extends st.Modal{constructor(t,e,i){super(t);this.onSelect=e,this.selectedEmoji=i}onOpen(){this.titleEl.setText("\u7D75\u6587\u5B57\u3092\u9078\u629E"),this.contentEl.addClass("emoji-picker-modal");let t=this.contentEl.createDiv({cls:"emoji-picker-container"});gt.forEach(n=>{let r=t.createDiv({cls:"emoji-category"}),o=r.createEl("h3",{text:n.name,cls:"emoji-category-title"});o.style.fontSize="0.9rem",o.style.fontWeight="600",o.style.marginBottom="8px",o.style.color="var(--text-normal)";let c=r.createDiv({cls:"emoji-grid"});c.style.display="grid",c.style.gridTemplateColumns="repeat(auto-fill, minmax(40px, 1fr))",c.style.gap="6px",c.style.marginBottom="20px",n.emojis.forEach(a=>{let l=c.createEl("button",{text:a,cls:"emoji-button"});l.style.fontSize="1.5rem",l.style.padding="8px",l.style.border="2px solid var(--background-modifier-border)",l.style.borderRadius="6px",l.style.background="var(--background-primary)",l.style.cursor="pointer",l.style.transition="all 0.15s ease",this.selectedEmoji===a&&(l.style.borderColor="var(--interactive-accent)",l.style.background="var(--background-modifier-hover)"),l.addEventListener("mouseenter",()=>{this.selectedEmoji!==a&&(l.style.background="var(--background-modifier-hover)",l.style.transform="scale(1.1)")}),l.addEventListener("mouseleave",()=>{this.selectedEmoji!==a&&(l.style.background="var(--background-primary)",l.style.transform="scale(1)")}),l.addEventListener("click",()=>{this.selectedEmoji=a,this.onSelect(a),this.close()})})});let e=this.contentEl.createDiv();e.style.display="flex",e.style.justifyContent="flex-end",e.style.marginTop="20px";let i=e.createEl("button",{text:"\u30AD\u30E3\u30F3\u30BB\u30EB"});i.style.padding="8px 16px",i.addEventListener("click",()=>this.close())}onClose(){this.contentEl.empty()}};var M=class extends u.PluginSettingTab{constructor(t,e,i,n){super(t,e);this.settings=i,this.callbacks=n}display(){this.containerEl.empty(),this.containerEl.addClass("abyss-settings"),this.renderPriorityManagement(),this.renderUISettings(),this.renderStatistics(),this.renderDebug()}renderPriorityManagement(){let t=this.createSection("\u512A\u5148\u5EA6\u7BA1\u7406","\u601D\u8003\u30AD\u30E3\u30D7\u30C1\u30E3\u6642\u306B\u4F7F\u7528\u3059\u308B\u512A\u5148\u5EA6\u3092\u7BA1\u7406\u3057\u307E\u3059\u3002");if(new u.Setting(t).setName("\u512A\u5148\u5EA6\u30D7\u30EA\u30BB\u30C3\u30C8").setDesc("\u4F7F\u7528\u3059\u308B\u512A\u5148\u5EA6\u30BB\u30C3\u30C8\u3092\u9078\u629E").addDropdown(e=>{f.forEach(i=>{e.addOption(i.id,i.name)}),e.addOption("custom","\u30AB\u30B9\u30BF\u30E0"),e.setValue(this.settings.selectedPreset).onChange(async i=>{if(this.settings.selectedPreset=i,i!=="custom"){let n=f.find(r=>r.id===i);n&&(this.settings.priorities=[...n.priorities])}await this.saveSettings(),this.display()})}),this.settings.selectedPreset!=="custom"){let e=f.find(i=>i.id===this.settings.selectedPreset);if(e){let i=t.createDiv({cls:"preset-description"});i.style.marginBottom="15px",i.style.padding="10px",i.style.background="var(--background-secondary)",i.style.borderRadius="4px",i.style.fontSize="0.875rem",i.textContent=e.description}}this.settings.selectedPreset==="custom"?this.renderCustomPriorities(t):this.renderPriorityPreview(t)}renderPriorityPreview(t){let e=t.createDiv({cls:"priorities-preview"});e.style.marginTop="15px";let i=e.createEl("h4",{text:"\u73FE\u5728\u306E\u512A\u5148\u5EA6"});i.style.marginBottom="10px";let n=e.createDiv({cls:"priorities-list"});this.settings.priorities.forEach(r=>{let c=n.createDiv({cls:"priority-item"}).createDiv({cls:"priority-info"}),a=c.createSpan({text:r.symbol,cls:"priority-symbol"});a.style.fontSize="1.5rem";let l=c.createSpan({text:r.label,cls:"priority-label"});if(l.style.fontWeight="600",l.style.marginLeft="10px",r.description){let h=c.createSpan({text:r.description,cls:"priority-desc"});h.style.fontSize="0.875rem",h.style.color="var(--text-muted)",h.style.marginLeft="10px"}})}renderCustomPriorities(t){let e=t.createDiv("priorities-list");if(this.settings.priorities.length===0){let n=t.createDiv();n.style.marginBottom="15px",n.style.padding="10px",n.style.color="var(--text-muted)",n.style.fontSize="0.875rem",n.textContent="\u512A\u5148\u5EA6\u304C\u767B\u9332\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002"}else this.settings.priorities.forEach((n,r)=>{this.renderPriorityItem(e,n,r)});let i=this.settings.priorities.length>=w.maxCustomPriorities;new u.Setting(t).setName("\u512A\u5148\u5EA6\u3092\u8FFD\u52A0").setDesc(i?`\u6700\u5927${w.maxCustomPriorities}\u3064\u307E\u3067\u767B\u9332\u3067\u304D\u307E\u3059`:"").addButton(n=>n.setButtonText("\u65B0\u898F\u8FFD\u52A0").setCta().setDisabled(i).onClick(()=>this.showAddPriorityDialog())),this.settings.priorities.length>1&&new u.Setting(t).setName("\u30D7\u30EA\u30BB\u30C3\u30C8\u306B\u30EA\u30BB\u30C3\u30C8").setDesc("\u30B9\u30BF\u30F3\u30C0\u30FC\u30C9\u30D7\u30EA\u30BB\u30C3\u30C8\u306B\u623B\u3057\u307E\u3059").addButton(n=>{n.setButtonText("\u30EA\u30BB\u30C3\u30C8").onClick(async()=>{await this.showConfirm("\u30EA\u30BB\u30C3\u30C8\u78BA\u8A8D","\u512A\u5148\u5EA6\u3092\u30B9\u30BF\u30F3\u30C0\u30FC\u30C9\u30D7\u30EA\u30BB\u30C3\u30C8\u306B\u623B\u3057\u307E\u3059\u304B\uFF1F")&&(this.settings.priorities=[...f[0].priorities],await this.saveSettings(),this.display(),new u.Notice("\u512A\u5148\u5EA6\u3092\u30EA\u30BB\u30C3\u30C8\u3057\u307E\u3057\u305F"))}),n.buttonEl.addClass("abyss-warning-btn")})}renderPriorityItem(t,e,i){let n=t.createDiv("priority-item"),r=n.createDiv("priority-info"),o=r.createSpan({text:e.symbol,cls:"priority-symbol"});o.style.fontSize="1.5rem";let c=r.createSpan({text:e.label,cls:"priority-label"});if(c.style.fontWeight="600",c.style.marginLeft="10px",e.description){let h=r.createSpan({text:e.description,cls:"priority-desc"});h.style.fontSize="0.875rem",h.style.color="var(--text-muted)",h.style.marginLeft="10px"}let a=n.createDiv("priority-actions");a.createEl("button",{text:"\u7DE8\u96C6"}).addEventListener("click",()=>this.showEditPriorityDialog(e,i)),this.settings.priorities.length>1&&a.createEl("button",{text:"\u524A\u9664",cls:"abyss-delete-btn"}).addEventListener("click",()=>this.deletePriority(i)),i>0&&a.createEl("button",{text:"\u2191"}).addEventListener("click",()=>this.movePriority(i,-1)),i<this.settings.priorities.length-1&&a.createEl("button",{text:"\u2193"}).addEventListener("click",()=>this.movePriority(i,1))}showAddPriorityDialog(){if(this.settings.priorities.length>=w.maxCustomPriorities){new u.Notice("\u30AB\u30B9\u30BF\u30E0\u512A\u5148\u5EA6\u306F\u6700\u59278\u3064\u307E\u3067\u3067\u3059");return}new H(this.app,"\u65B0\u3057\u3044\u512A\u5148\u5EA6\u3092\u8FFD\u52A0",void 0,async t=>{if(this.settings.priorities.some(i=>i.symbol===t.symbol||i.label.toLowerCase()===t.label.toLowerCase()))throw new Error("\u540C\u3058\u7D75\u6587\u5B57\u307E\u305F\u306F\u30E9\u30D9\u30EB\u306E\u512A\u5148\u5EA6\u304C\u65E2\u306B\u5B58\u5728\u3057\u307E\u3059");this.settings.priorities.push(t),await this.saveSettings(),this.display(),new u.Notice(p.success.priorityAdded)}).open()}showEditPriorityDialog(t,e){new H(this.app,"\u512A\u5148\u5EA6\u3092\u7DE8\u96C6",t,async i=>{if(this.settings.priorities.some((r,o)=>o!==e&&(r.symbol===i.symbol||r.label.toLowerCase()===i.label.toLowerCase())))throw new Error("\u540C\u3058\u7D75\u6587\u5B57\u307E\u305F\u306F\u30E9\u30D9\u30EB\u306E\u512A\u5148\u5EA6\u304C\u65E2\u306B\u5B58\u5728\u3057\u307E\u3059");this.settings.priorities[e]=i,await this.saveSettings(),this.display(),new u.Notice("\u512A\u5148\u5EA6\u3092\u66F4\u65B0\u3057\u307E\u3057\u305F")}).open()}async deletePriority(t){let e=this.settings.priorities[t];await this.showConfirm("\u524A\u9664\u78BA\u8A8D",`\u300C${e.label}\u300D\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F`)&&(this.settings.priorities.splice(t,1),await this.saveSettings(),this.display(),new u.Notice(p.success.priorityDeleted))}async movePriority(t,e){let i=t+e;if(i<0||i>=this.settings.priorities.length)return;let n=this.settings.priorities[t];this.settings.priorities[t]=this.settings.priorities[i],this.settings.priorities[i]=n,await this.saveSettings(),this.display()}renderUISettings(){let t=this.createSection("UI\u8A2D\u5B9A","\u30E6\u30FC\u30B6\u30FC\u30A4\u30F3\u30BF\u30FC\u30D5\u30A7\u30FC\u30B9\u306E\u52D5\u4F5C\u3092\u8A2D\u5B9A\u3067\u304D\u307E\u3059\u3002");new u.Setting(t).setName("\u901A\u77E5\u3092\u8868\u793A").setDesc("\u601D\u8003\u3092\u4FDD\u5B58\u3057\u305F\u3068\u304D\u306B\u901A\u77E5\u3092\u8868\u793A\u3059\u308B").addToggle(e=>e.setValue(this.settings.showNotifications).onChange(async i=>{this.settings.showNotifications=i,await this.saveSettings()})),new u.Setting(t).setName("\u601D\u8003\u5F8C\u306B Advent log \u3092\u81EA\u52D5\u3067\u958B\u304F").setDesc("\u601D\u8003\u3092\u30AD\u30E3\u30D7\u30C1\u30E3\u3057\u305F\u5F8C\u3001\u81EA\u52D5\u7684\u306B Advent log \u3092\u958B\u304F").addToggle(e=>e.setValue(this.settings.autoOpenAdventLog).onChange(async i=>{this.settings.autoOpenAdventLog=i,await this.saveSettings()})),new u.Setting(t).setName("\u30A2\u30FC\u30AB\u30A4\u30D6\u6642\u306B done \u30ED\u30B0\u3092\u6B8B\u3059").setDesc("Advent view \u3067\u30A2\u30FC\u30AB\u30A4\u30D6\u3059\u308B\u969B\u3001done \u30ED\u30B0\u3068\u3057\u3066\u8A18\u9332\u3059\u308B").addToggle(e=>e.setValue(this.settings.logArchiveAsDone).onChange(async i=>{this.settings.logArchiveAsDone=i,await this.saveSettings()})),this.settings.logArchiveAsDone&&new u.Setting(t).setName("done \u30ED\u30B0\u30C6\u30F3\u30D7\u30EC\u30FC\u30C8").setDesc("\u30D7\u30EC\u30FC\u30B9\u30DB\u30EB\u30C0\u30FC: {emoji} = \u7D75\u6587\u5B57, {content} = \u30ED\u30B0\u5185\u5BB9").addText(e=>e.setPlaceholder("{emoji}\u300C{content}\u300D\u3092\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002").setValue(this.settings.doneLogTemplate).onChange(async i=>{this.settings.doneLogTemplate=i,await this.saveSettings()}))}renderStatistics(){let t=this.createSection("\u4F7F\u7528\u7D71\u8A08","\u30D7\u30E9\u30B0\u30A4\u30F3\u306E\u4F7F\u7528\u72B6\u6CC1\u3068\u7D71\u8A08\u60C5\u5831\u3092\u8868\u793A\u3057\u307E\u3059\u3002");this.loadAndDisplayStats(t)}async loadAndDisplayStats(t){let e=t.createDiv({text:"\u7D71\u8A08\u60C5\u5831\u3092\u8AAD\u307F\u8FBC\u307F\u4E2D..."});try{let i=await this.callbacks.getStats();e.remove();let n=t.createDiv("stats-grid");if(this.createStatCard(n,i.totalThoughts.toString(),"\u7DCF\u601D\u8003\u6570"),this.createStatCard(n,i.averageThoughtsPerDay.toString(),"1\u65E5\u5E73\u5747\u601D\u8003\u6570"),i.lastThoughtDate){let r=it(i.lastThoughtDate);this.createStatCard(n,r,"\u6700\u5F8C\u306E\u601D\u8003\u8A18\u9332")}}catch(i){e.textContent="\u7D71\u8A08\u60C5\u5831\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"}}createStatCard(t,e,i){let n=t.createDiv("stat-card");n.createDiv({text:e,cls:"stat-value"}),n.createDiv({text:i,cls:"stat-label"})}renderDebug(){let t=this.createSection("\u30C7\u30D0\u30C3\u30B0\u60C5\u5831","\u30B7\u30B9\u30C6\u30E0\u306E\u554F\u984C\u3092\u8A3A\u65AD\u3059\u308B\u305F\u3081\u306E\u60C5\u5831\u3067\u3059\u3002");new u.Setting(t).setName("\u8A2D\u5B9A\u60C5\u5831\u3092\u8868\u793A").addButton(e=>e.setButtonText("\u8A2D\u5B9A\u3092\u8868\u793A").onClick(()=>this.showDebugInfo()))}showDebugInfo(){let t=new u.Modal(this.app);t.titleEl.setText("\u30C7\u30D0\u30C3\u30B0\u60C5\u5831");let e={version:"1.5.0",settings:this.settings,timestamp:new Date().toISOString()},i=t.contentEl.createEl("pre");i.textContent=JSON.stringify(e,null,2),i.style.fontSize="12px",i.style.maxHeight="400px",i.style.overflow="auto",t.open()}createSection(t,e){let i=this.containerEl.createDiv("abyss-settings-section");return i.createEl("h2",{text:t}),e&&i.createEl("p",{text:e}),i}async saveSettings(){try{await this.callbacks.saveSettings()}catch(t){this.handleError("\u8A2D\u5B9A\u306E\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F",t)}}async showConfirm(t,e){return new Promise(i=>{let n=new u.Modal(this.app);n.titleEl.setText(t),n.contentEl.createEl("p",{text:e});let r=n.contentEl.createDiv();r.style.display="flex",r.style.gap="10px",r.style.justifyContent="flex-end",r.createEl("button",{text:"\u30AD\u30E3\u30F3\u30BB\u30EB"}).addEventListener("click",()=>{n.close(),i(!1)}),r.createEl("button",{text:"\u5B9F\u884C",cls:"mod-warning"}).addEventListener("click",()=>{n.close(),i(!0)}),n.open()})}handleError(t,e){let i=e instanceof Error?e.message:String(e);new u.Notice(`${t}: ${i}`,6e3)}},H=class extends u.Modal{constructor(t,e,i,n){super(t);this.title=e,this.originalPriority=i,this.onSave=n,this.priority=i?{...i}:{symbol:"",label:"",description:"",showInAdventView:!0}}onOpen(){this.titleEl.setText(this.title);let t=this.contentEl.createDiv();this.createEmojiSelector(t);let e=this.createField(t,"\u30E9\u30D9\u30EB",this.priority.label,c=>{this.priority.label=c});e.placeholder="\u4F8B: todo";let i=this.createField(t,"\u8AAC\u660E\uFF08\u4EFB\u610F\uFF09",this.priority.description,c=>{this.priority.description=c});i.placeholder="\u4F8B: \u3084\u308B\u3053\u3068",this.createShowInAdventViewCheckbox(t);let n=t.createDiv();n.style.display="flex",n.style.gap="10px",n.style.justifyContent="flex-end",n.style.marginTop="20px",n.createEl("button",{text:"\u30AD\u30E3\u30F3\u30BB\u30EB"}).addEventListener("click",()=>this.close()),n.createEl("button",{text:this.originalPriority?"\u66F4\u65B0":"\u8FFD\u52A0",cls:"mod-cta"}).addEventListener("click",()=>this.handleSave()),setTimeout(()=>e.focus(),100)}createEmojiSelector(t){let e=t.createDiv();e.style.marginBottom="15px",e.createEl("label",{text:"\u7D75\u6587\u5B57"});let i=e.createDiv();i.style.display="flex",i.style.alignItems="center",i.style.gap="10px",i.style.marginTop="5px";let n=i.createEl("span",{text:this.priority.symbol||"\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044",cls:"emoji-preview"});n.style.fontSize="2rem",n.style.minWidth="50px",n.style.textAlign="center";let r=i.createEl("button",{text:"\u7D75\u6587\u5B57\u3092\u9078\u629E",cls:"mod-cta"});r.style.padding="8px 16px",r.addEventListener("click",()=>{new V(this.app,o=>{this.priority.symbol=o,n.textContent=o},this.priority.symbol).open()})}createField(t,e,i,n){let r=t.createDiv();r.style.marginBottom="15px",r.createEl("label",{text:e});let o=r.createEl("input",{type:"text",value:i});return o.style.width="100%",o.style.marginTop="5px",o.style.padding="8px",o.style.fontSize="14px",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px",o.addEventListener("input",()=>n(o.value)),o}createShowInAdventViewCheckbox(t){var o;let e=t.createDiv();e.style.marginBottom="15px";let i=e.createDiv();i.style.display="flex",i.style.alignItems="center",i.style.gap="8px";let n=i.createEl("input",{type:"checkbox"});n.checked=(o=this.priority.showInAdventView)!=null?o:!0,n.addEventListener("change",()=>{this.priority.showInAdventView=n.checked});let r=i.createEl("label",{text:"Advent view \u306B\u8868\u793A"});r.style.cursor="pointer",r.addEventListener("click",()=>{n.checked=!n.checked,this.priority.showInAdventView=n.checked})}async handleSave(){if(!this.priority.symbol.trim()){new u.Notice("\u7D75\u6587\u5B57\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}if(!this.priority.label.trim()){new u.Notice("\u30E9\u30D9\u30EB\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}try{await this.onSave(this.priority),this.close()}catch(t){let e=t instanceof Error?t.message:String(t);new u.Notice(`\u64CD\u4F5C\u306B\u5931\u6557\u3057\u307E\u3057\u305F: ${e}`)}}};var nt=require("obsidian");var A=class{constructor(s,t,e){this.app=s,this.vault=s.vault,this.settings=t,this.logger=e,this.validator=new C}async initializeFolders(){try{return await this.waitForVaultReady(),await this.createFolders(),T()}catch(s){let t=s instanceof g?s:new g(p.error.folderCreation,"FOLDER_INIT_FAILED");return this.logger.logError(t,"initializeFolders"),I(t.message)}}async waitForVaultReady(){let t=Date.now();return new Promise((e,i)=>{let n=()=>{if(Date.now()-t>1e4){i(new g("Vault initialization timeout","VAULT_TIMEOUT"));return}this.vault.adapter?setTimeout(e,100):setTimeout(n,50)};n()})}async createFolders(){for(let s of et)await this.createFolderIfNotExists(s)}async createFolderIfNotExists(s){try{this.validator.validateFilePath(s);let t=s.replace(/\\/g,"/");this.vault.getAbstractFileByPath(t)||(await this.vault.createFolder(t),this.logger.debug(`Created folder: ${t}`))}catch(t){if(t instanceof Error&&t.message.includes("already exists"))return;throw new g(`Failed to create folder ${s}`,"FOLDER_CREATE_FAILED")}}async saveThought(s){try{this.validator.validateThought(s);let t=await this.getOrCreateThoughtLogFile(),e=await this.vault.read(t);e=this.updateHeaderPriorityList(e),e=this.ensureAdventViewLink(e);let i;return s.isContinuation?i=this.appendToLastThought(e,s):i=this.insertThoughtIntoContent(e,s),await this.vault.modify(t,i),this.logger.info("Thought saved successfully",{thoughtId:s.id,isContinuation:s.isContinuation}),T()}catch(t){let e=t instanceof g?t:new g(p.error.fileSave,"THOUGHT_SAVE_FAILED");return this.logger.logError(e,"saveThought"),I(e.message)}}ensureAdventViewLink(s){let t=this.generatePriorityListText(),e="[\u{1F4CB} Advent view](obsidian://abyss-open-advent-view)",i=`# Advent log

${t}
${e}

---`,n=s.split(`
`),r=-1;for(let h=0;h<n.length;h++)if(n[h].startsWith("---")){r=h;break}if(r===-1)return i+`
`+s;let o=n.slice(0,r),c=o.some(h=>h.includes("\u2795more")),a=o.some(h=>h.includes(e));if(!(o.length>=4&&o[0]==="# Advent log"&&o[1]===""&&c&&a)){let h=n.slice(r+1);return i+`
`+h.join(`
`)}return s}appendToLastThought(s,t){let e=s.split(`
`),i=this.findHeaderEndIndex(e);for(let n=i;n<e.length;n++)if(this.isThoughtLine(e[n])){let r=n+1;for(;r<e.length&&e[r].trim()!==""&&(e[r].startsWith("  ")||e[r].startsWith("	"));)r++;return e.splice(r,0,`  \u2795 ${t.content}`),e.join(`
`)}throw new g(p.error.noPreviousThought,"NO_PREVIOUS_THOUGHT")}isThoughtLine(s){return A.THOUGHT_LINE_PATTERN.test(s)}async getOrCreateThoughtLogFile(){let s=P,t=this.vault.getAbstractFileByPath(s);if(!t){let e=this.generateInitialFileContent();t=await this.vault.create(s,e)}if(!(t instanceof nt.TFile))throw new g("Failed to create Advent log file","ADVENT_LOG_FILE_ERROR");return t}insertThoughtIntoContent(s,t){let i=`## ${J(t.timestamp)}`,r=`${X(t.timestamp)} ${t.priority} ${t.content}`,o=s.split(`
`),c=o.findIndex(a=>a===i);if(c!==-1){let a=c+1;for(;a<o.length&&o[a].trim()==="";)a++;return o.splice(a,0,r),o.join(`
`)}else{let a=this.findHeaderEndIndex(o),l=-1;for(let h=a;h<o.length;h++)if(o[h].startsWith("## ")){l=h;break}return l!==-1?o.splice(l,0,i,"",r,""):o.splice(a,0,"",i,"",r),o.join(`
`)}}findHeaderEndIndex(s){for(let t=0;t<s.length;t++)if(s[t].startsWith("---"))return t+1;return 0}generateInitialFileContent(){return`# Advent log

${this.generatePriorityListText()}
[\u{1F4CB} Advent view](obsidian://abyss-open-advent-view)

---
  `}generatePriorityListText(){return`${this.settings.priorities.map(t=>`${t.symbol}${t.label}`).join(" ")} \u2795more`}updateHeaderPriorityList(s){var i;let t=s.split(`
`),e=this.generatePriorityListText();for(let n=0;n<t.length;n++)if(A.EMOJI_PATTERN.test(t[n])&&!t[n].startsWith("[")&&n<t.length-1&&(i=t[n+2])!=null&&i.startsWith("---")){t[n]=e;break}return t.join(`
`)}async getStats(){try{let s=await this.getOrCreateThoughtLogFile(),t=await this.vault.read(s),e=new RegExp(A.THOUGHT_LINE_PATTERN.source,"gm"),i=t.match(e)||[],n=new RegExp(A.DATE_SECTION_PATTERN.source,"gm"),r=t.match(n)||[],o=s.stat.mtime>0?new Date(s.stat.mtime):void 0,c=r.length>0?Number((i.length/r.length).toFixed(1)):0;return{totalLogFiles:1,totalThoughts:i.length,lastThoughtDate:o,averageThoughtsPerDay:c}}catch(s){return this.logger.error("Failed to get stats:",s),{totalLogFiles:0,totalThoughts:0,averageThoughtsPerDay:0}}}updateSettings(s){this.settings=s}async archiveThought(s){try{let t=await this.getOrCreateThoughtLogFile(),i=(await this.vault.read(t)).split(`
`);if(s<0||s>=i.length)throw new g("Invalid line number","INVALID_LINE_NUMBER");let n=i[s];return n.includes("[done]")?T():(i[s]=`${n} [done]`,await this.vault.modify(t,i.join(`
`)),this.logger.info("Thought archived successfully",{lineNumber:s}),T())}catch(t){let e=t instanceof g?t:new g("Failed to archive thought","ARCHIVE_FAILED");return this.logger.logError(e,"archiveThought"),I(e.message)}}async addDoneLog(s){var t;try{if(!this.settings.logArchiveAsDone)return T();let e=((t=this.settings.priorities.find(y=>y.label==="done"))==null?void 0:t.symbol)||"\u2728",i=new Date,n=J(i),r=X(i),c=(this.settings.doneLogTemplate||"{emoji}\u300C{content}\u300D\u3092\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002").replace("{emoji}",s.symbol).replace("{content}",s.content),a={id:`done-${Date.now()}`,content:c,priority:e,timestamp:i},l=await this.getOrCreateThoughtLogFile(),h=await this.vault.read(l);h=this.updateHeaderPriorityList(h);let L=this.insertThoughtIntoContent(h,a);return await this.vault.modify(l,L),this.logger.info("Done log added successfully"),T()}catch(e){let i=e instanceof g?e:new g("Failed to add done log","DONE_LOG_FAILED");return this.logger.logError(i,"addDoneLog"),I(i.message)}}},x=A;x.THOUGHT_LINE_PATTERN=/^\d{2}:\d{2}\s+[^\x00-\x7F]/,x.EMOJI_PATTERN=/[^\x00-\x7F]/,x.DATE_SECTION_PATTERN=/^## \d{4}\/\d{2}\/\d{2}/;var k=require("obsidian");var R=class{parseAdventLog(s,t){let e=s.split(`
`),i=[],n="",r=0;for(let o=0;o<e.length;o++){let c=e[o];r=o;let a=c.match(/^## (\d{4}\/\d{2}\/\d{2})/);if(a){n=a[1];continue}let l=c.match(/^(\d{2}:\d{2})\s+([^\x00-\x7F]+)\s+(.+)$/);if(l&&n){let h=l[1],L=l[2],y=l[3],U=y.includes("[done]");y=y.replace(/\s*\[done\]\s*$/,"").trim();let q=[],D=o+1;for(;D<e.length;){let Q=e[D],Z=Q.match(/^\s+âž•\s+(.+)$/);if(Z)q.push(Z[1]),D++;else if(Q.trim()==="")D++;else break}i.push({time:h,date:n,symbol:L,content:y,continuations:q,isDone:U,rawLine:c,lineNumber:r}),o=D-1}}return i}filterByCategory(s,t){return s.filter(e=>e.symbol===t&&!e.isDone)}filterByShowInAdventView(s,t){let e=t.filter(i=>i.showInAdventView!==!1).map(i=>i.symbol);return s.filter(i=>e.includes(i.symbol)&&!i.isDone)}};var O="abyss-advent-view-side",F="abyss-advent-view-main",B=class{constructor(s,t,e){this.currentCategory=null;this.thoughts=[];this.app=s,this.settings=t,this.parser=new R,this.fileManager=e}async loadThoughts(){let s=this.app.vault.getAbstractFileByPath(P);if(s instanceof k.TFile){let t=await this.app.vault.read(s);this.thoughts=this.parser.parseAdventLog(t,this.settings.priorities)}else this.thoughts=[];this.currentCategory===null&&(this.currentCategory=this.getDefaultCategory())}getDefaultCategory(){let s=this.getVisibleCategories();if(s.length===0)return null;for(let t of s)if(this.parser.filterByCategory(this.thoughts,t.symbol).length>0)return t.symbol;return s[0].symbol}getVisibleCategories(){return this.settings.priorities.filter(s=>s.showInAdventView!==!1)}getFilteredThoughts(){return this.currentCategory?this.parser.filterByCategory(this.thoughts,this.currentCategory):this.parser.filterByShowInAdventView(this.thoughts,this.settings.priorities)}async archiveThought(s){await this.fileManager.archiveThought(s.lineNumber),await this.fileManager.addDoneLog(s),await this.loadThoughts()}renderThoughtItem(s,t,e,i){let n=s.createDiv("advent-thought-item"),r=n.createEl("input",{type:"checkbox"});r.classList.add("advent-checkbox");let o=n.createDiv("advent-thought-content"),c=o.createDiv("advent-thought-main");if(c.textContent=t.content,t.continuations.length>0){let L=o.createDiv("advent-continuations");t.continuations.forEach(y=>{let U=L.createDiv("advent-continuation-item");U.textContent=`\u2192 ${y}`})}let a=o.createDiv("advent-thought-meta");a.textContent=`${t.date} ${t.time}`;let l=e?"\u{1F4C1} \u30A2\u30FC\u30AB\u30A4\u30D6":"\u{1F4C1}",h=n.createEl("button",{text:l,cls:"advent-archive-btn"});e||(h.title="\u30A2\u30FC\u30AB\u30A4\u30D6"),h.addEventListener("click",i),r.addEventListener("change",()=>{r.checked?n.addClass("checked"):n.removeClass("checked")})}},j=class extends k.ItemView{constructor(t,e,i){super(t);this.settings=e,this.fileManager=i,this.core=new B(this.app,e,i)}getViewType(){return O}getDisplayText(){return"Advent view"}getIcon(){return"list-todo"}async onOpen(){await this.core.loadThoughts(),this.render()}async onClose(){}render(){let t=this.containerEl.children[1];t.empty(),t.addClass("advent-view-container"),t.addClass("advent-view-side");let e=t.createDiv("advent-view-header");e.createEl("h4",{text:"Advent view"}),e.createEl("button",{text:"\u{1F504}",cls:"advent-refresh-btn"}).addEventListener("click",async()=>{await this.core.loadThoughts(),this.render()});let n=t.createDiv("advent-category-tabs");this.core.getVisibleCategories().forEach(a=>{let l=n.createEl("button",{text:`${a.symbol}`,cls:"advent-category-tab"});this.core.currentCategory===a.symbol&&l.addClass("active"),l.addEventListener("click",async()=>{this.core.currentCategory=a.symbol,await this.core.loadThoughts(),this.render()})});let o=t.createDiv("advent-thought-list"),c=this.core.getFilteredThoughts();c.length===0?o.createDiv({text:"\u30A2\u30A4\u30C6\u30E0\u306F\u3042\u308A\u307E\u305B\u3093",cls:"advent-empty-message"}):c.forEach(a=>{this.core.renderThoughtItem(o,a,!1,async()=>{await this.core.archiveThought(a),this.render()})})}async refresh(){await this.core.loadThoughts(),this.render()}},$=class extends k.ItemView{constructor(t,e,i){super(t);this.settings=e,this.fileManager=i,this.core=new B(this.app,e,i)}getViewType(){return F}getDisplayText(){return"Advent view"}getIcon(){return"list-todo"}async onOpen(){await this.core.loadThoughts(),this.render()}async onClose(){}render(){let t=this.containerEl.children[1];t.empty(),t.addClass("advent-view-container"),t.addClass("advent-view-main");let e=t.createDiv("advent-view-header");e.createEl("h2",{text:"Advent view"}),e.createEl("button",{text:"\u{1F504} \u66F4\u65B0",cls:"advent-refresh-btn"}).addEventListener("click",async()=>{await this.core.loadThoughts(),this.render()});let n=t.createDiv("advent-category-tabs");this.core.getVisibleCategories().forEach(a=>{let l=n.createEl("button",{text:`${a.symbol} ${a.label}`,cls:"advent-category-tab"});this.core.currentCategory===a.symbol&&l.addClass("active"),l.addEventListener("click",async()=>{this.core.currentCategory=a.symbol,await this.core.loadThoughts(),this.render()})});let o=t.createDiv("advent-thought-list"),c=this.core.getFilteredThoughts();c.length===0?o.createDiv({text:"\u30A2\u30A4\u30C6\u30E0\u306F\u3042\u308A\u307E\u305B\u3093",cls:"advent-empty-message"}):c.forEach(a=>{this.core.renderThoughtItem(o,a,!0,async()=>{await this.core.archiveThought(a),this.render()})})}async refresh(){await this.core.loadThoughts(),this.render()}};var z=class extends S.Plugin{async onload(){this.logger=new N(tt.name),this.validator=new C;try{await this.initializePlugin(),await this.migrateFromV15(),this.logger.info("Plugin loaded successfully")}catch(t){this.handleError("Plugin initialization failed",t)}}async migrateFromV15(){let t=this.settings;(t.contextPrefixes||t.recentContexts||t.showContextSelection!==void 0)&&(this.logger.info("Migrating from v1.5..."),delete t.contextPrefixes,delete t.recentContexts,delete t.showContextSelection,this.settings.selectedPreset||(this.settings.selectedPreset="standard"),(!this.settings.priorities||this.settings.priorities.length===0)&&(this.settings.priorities=[...f[0].priorities]),await this.saveSettings(),this.logger.info("Migration completed"),new S.Notice(`Abyss v1.2\u306B\u30A2\u30C3\u30D7\u30C7\u30FC\u30C8\u3057\u307E\u3057\u305F\uFF01
\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u6A5F\u80FD\u304C\u524A\u9664\u3055\u308C\u3001\u3088\u308A\u30B7\u30F3\u30D7\u30EB\u306B\u306A\u308A\u307E\u3057\u305F\u3002`,8e3))}onunload(){this.logger.info("Plugin unloaded")}async initializePlugin(){await this.loadSettings(),this.fileManager=new x(this.app,this.settings,this.logger),this.registerViews(),this.registerCommands(),this.registerUI(),this.registerSettingTab(),this.registerURIHandlers(),await this.initializeFolders()}registerViews(){this.registerView(O,t=>new j(t,this.settings,this.fileManager)),this.registerView(F,t=>new $(t,this.settings,this.fileManager))}registerURIHandlers(){this.registerObsidianProtocolHandler("abyss-open-advent-view",async()=>{await this.activateAdventViewSide()})}async activateAdventViewSide(){let{workspace:t}=this.app,e=null,i=t.getLeavesOfType(O);if(i.length>0)e=i[0];else{let n=t.getRightLeaf(!1);n&&(e=n,await e.setViewState({type:O,active:!0}))}e&&t.revealLeaf(e)}async activateAdventViewMain(){let{workspace:t}=this.app,e=null,i=t.getLeavesOfType(F);i.length>0?e=i[0]:(e=t.getLeaf("tab"),await e.setViewState({type:F,active:!0})),e&&t.revealLeaf(e)}async loadSettings(){try{let t=await this.loadData();this.settings=this.validator.validateSettings(t)}catch(t){this.logger.error("Failed to load settings, using defaults:",t),this.settings={...v}}}async saveSettings(){var t;try{let e=this.validator.validateSettings(this.settings);await this.saveData(e),this.settings=e,(t=this.fileManager)==null||t.updateSettings(e)}catch(e){throw this.logger.error("Failed to save settings:",e),new g(p.error.settingsLoad,"SETTINGS_SAVE_FAILED")}}registerCommands(){this.addCommand({id:"capture-thought",name:"\u601D\u8003\u3092\u30AD\u30E3\u30D7\u30C1\u30E3",callback:()=>this.openCaptureModal(),hotkeys:[{modifiers:K.capture.modifiers,key:K.capture.key}]}),this.addCommand({id:"open-advent-view-main",name:"Advent view \u3092\u958B\u304F",callback:()=>this.activateAdventViewMain()}),this.addCommand({id:"open-advent-view-side",name:"Advent view \u3092\u30B5\u30A4\u30C9\u30D0\u30FC\u3067\u958B\u304F",callback:()=>this.activateAdventViewSide()})}registerUI(){this.addRibbonIcon("brain","\u601D\u8003\u3092\u30AD\u30E3\u30D7\u30C1\u30E3",()=>this.openCaptureModal()),this.addRibbonIcon("list-todo","Advent view \u3092\u958B\u304F",()=>this.activateAdventViewMain())}registerSettingTab(){this.addSettingTab(new M(this.app,this,this.settings,{saveSettings:()=>this.saveSettings(),initializeFolders:()=>this.fileManager.initializeFolders(),getStats:()=>this.fileManager.getStats()}))}async initializeFolders(){if(!this.settings.foldersInitialized)try{(await this.fileManager.initializeFolders()).success&&(this.settings.foldersInitialized=!0,await this.saveSettings())}catch(t){this.logger.error("Folder initialization error:",t)}}openCaptureModal(){try{new _(this.app,this.settings,{onThoughtSaved:e=>this.saveThought(e)}).open()}catch(t){this.handleError("Failed to open capture modal",t)}}async saveThought(t){try{this.validator.validateThought(t);let e=await this.fileManager.saveThought(t);if(!e.success)throw new g(e.error||"Unknown error occurred","THOUGHT_SAVE_FAILED");if(await this.saveSettings(),this.logger.info("Thought saved successfully",{thoughtId:t.id}),this.settings.autoOpenAdventLog){let i=this.app.vault.getAbstractFileByPath(P);i instanceof S.TFile&&await this.app.workspace.getLeaf().openFile(i)}}catch(e){throw this.logger.error("Failed to save thought:",e),e}}handleError(t,e){let i=e instanceof Error?e.message:String(e),n=`${t}: ${i}`;this.logger.error(n),new S.Notice(n,5e3)}async reinitializeFolders(){this.settings.foldersInitialized=!1,(await this.fileManager.initializeFolders()).success&&(this.settings.foldersInitialized=!0,await this.saveSettings())}};0&&(module.exports={});
