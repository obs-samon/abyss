/*
Abyss - Thought Capture v2.2.0
i
*/

var K=Object.defineProperty;var at=Object.getOwnPropertyDescriptor;var lt=Object.getOwnPropertyNames;var ct=Object.prototype.hasOwnProperty;var dt=(h,r)=>{for(var t in r)K(h,t,{get:r[t],enumerable:!0})},ht=(h,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of lt(r))!ct.call(h,i)&&i!==t&&K(h,i,{get:()=>r[i],enumerable:!(e=at(r,i))||e.enumerable});return h};var gt=h=>ht(K({},"__esModule",{value:!0}),h);var vt={};dt(vt,{default:()=>Y});module.exports=gt(vt);var I=require("obsidian");var g=class extends Error{constructor(t,e="UNKNOWN_ERROR",i){super(t);this.name="AbyssError",this.code=e,this.context=i}};function P(h){return{success:!0,data:h}}function F(h){return{success:!1,error:h}}var et=Object.freeze({id:"Abyss-Thought-Capture",name:"Abyss - Thought Capture",version:"2.2.0",phase:"Phase 2.2"}),E=Object.freeze([{id:"standard",name:"\u30B9\u30BF\u30F3\u30C0\u30FC\u30C9",description:"\u6C4E\u7528\u7684\u306A\u512A\u5148\u5EA6\u30BB\u30C3\u30C8",priorities:Object.freeze([{symbol:"\u2705",label:"todo",description:"\u3084\u308B\u3053\u3068",showInAdventView:!0},{symbol:"\u{1F4A1}",label:"idea",description:"\u601D\u3044\u3064\u3044\u305F\u30A2\u30A4\u30C7\u30A2",showInAdventView:!0},{symbol:"\u2728",label:"done",description:"\u3084\u3063\u305F\u3053\u3068",showInAdventView:!1},{symbol:"\u{1F4AD}",label:"thought",description:"\u601D\u3063\u305F\u3053\u3068",showInAdventView:!1},{symbol:"\u{1F6D2}",label:"wishlist",description:"\u8CB7\u3044\u305F\u3044\u3082\u306E",showInAdventView:!0},{symbol:"\u{1F4CC}",label:"note",description:"\u899A\u3048\u3066\u304A\u304D\u305F\u3044\u3053\u3068",showInAdventView:!0}])}]),it="\u{1F504}",x=Object.freeze({symbol:"\u2795",label:"more",description:"\u76F4\u524D\u306E\u601D\u8003\u306B\u8FFD\u8A18"}),pt="Abyss",L="Abyss/Advent log.md",ft=Object.freeze({thoughtLogPath:"01-\u5165\u529B\u30A8\u30EA\u30A2",deepDiveFolder:"02-\u6DF1\u5800\u308A\u30CE\u30FC\u30C8",reviewFolder:"04-\u30EC\u30D3\u30E5\u30FC"});var st=Object.freeze([pt]),f=Object.freeze({showNotifications:!0,foldersInitialized:!1,selectedPreset:"standard",priorities:[...E[0].priorities],autoOpenAdventLog:!0,logArchiveAsDone:!0,doneLogTemplate:"[{emoji} {content}] was archived."}),S=Object.freeze({maxContentLength:100,maxPrioritiesDisplay:9,maxCustomPriorities:8}),W=Object.freeze({capture:{modifiers:["Mod","Shift"],key:"t"}}),m=Object.freeze({success:{thoughtSaved:"\u601D\u8003\u3092\u4FDD\u5B58\u3057\u307E\u3057\u305F",thoughtContinued:"\u524D\u306E\u601D\u8003\u306B\u8FFD\u8A18\u3057\u307E\u3057\u305F",foldersCreated:"\u30D5\u30A9\u30EB\u30C0\u69CB\u9020\u3092\u4F5C\u6210\u3057\u307E\u3057\u305F",priorityAdded:"\u512A\u5148\u5EA6\u3092\u8FFD\u52A0\u3057\u307E\u3057\u305F",priorityDeleted:"\u512A\u5148\u5EA6\u3092\u524A\u9664\u3057\u307E\u3057\u305F"},error:{folderCreation:"\u30D5\u30A9\u30EB\u30C0\u306E\u4F5C\u6210\u306B\u5931\u6557\u3057\u307E\u3057\u305F",fileSave:"\u601D\u8003\u306E\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F",settingsLoad:"\u8A2D\u5B9A\u306E\u8AAD\u307F\u8FBC\u307F\u306B\u5931\u6557\u3057\u307E\u3057\u305F",emptyContent:"\u601D\u8003\u5185\u5BB9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044",contentTooLong:"\u601D\u8003\u5185\u5BB9\u306F100\u6587\u5B57\u4EE5\u5185\u3067\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044",noPreviousThought:"\u8FFD\u8A18\u3059\u308B\u524D\u306E\u601D\u8003\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3067\u3057\u305F"}}),b=Object.freeze({modal:Object.freeze({container:"instant-deep-thinking-modal-container",modal:"instant-deep-thinking-modal",contextContainer:"context-container",contextGrid:"context-grid",contextButton:"context-button",priorityButton:"priority-button",thoughtInput:"thought-input",charCounter:"char-counter",saveButton:"save-button",backButton:"back-button"}),settings:Object.freeze({container:"abyss-settings",section:"abyss-settings-section",contextItem:"context-item"})}),J=Object.freeze({maxContentLength:S.maxContentLength,maxLabelLength:30,forbiddenChars:/[<>:"|?*\\\/]/}),bt=Object.freeze({weekdays:["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"]});var A=require("obsidian");var R=class{constructor(r,t=!0){this.prefix=`[${r}]`,this.enabled=t}debug(r,...t){this.log("debug",r,...t)}info(r,...t){this.log("info",r,...t)}warn(r,...t){this.log("warn",r,...t)}error(r,...t){this.log("error",r,...t)}logError(r,t){let e=t?` [${t}]`:"";this.error(`${e} ${r.message}`,{stack:r.stack})}log(r,t,...e){if(!this.enabled)return;let i=new Date().toISOString(),s=`${this.prefix} [${i}] ${t}`;switch(r){case"debug":console.debug(s,...e);break;case"info":console.info(s,...e);break;case"warn":console.warn(s,...e);break;case"error":console.error(s,...e);break}}},k=class{validateSettings(r){let t=r||{};return typeof t.showNotifications!="boolean"&&(t.showNotifications=f.showNotifications),typeof t.foldersInitialized!="boolean"&&(t.foldersInitialized=f.foldersInitialized),typeof t.autoOpenAdventLog!="boolean"&&(t.autoOpenAdventLog=f.autoOpenAdventLog),typeof t.logArchiveAsDone!="boolean"&&(t.logArchiveAsDone=f.logArchiveAsDone),typeof t.selectedPreset!="string"&&(t.selectedPreset=f.selectedPreset),!Array.isArray(t.priorities)||t.priorities.length===0?t.priorities=[...f.priorities]:t.priorities=this.validatePriorities(t.priorities),t}validatePriorities(r){var e;let t=[];for(let i of r)try{this.validatePriority(i),t.push({symbol:i.symbol.trim(),label:i.label.trim(),description:((e=i.description)==null?void 0:e.trim())||"",showInAdventView:i.showInAdventView!==!1})}catch(s){console.warn("Invalid priority found, skipping:",i)}return t.length>0?t:[...f.priorities]}validatePriority(r){if(!r||typeof r!="object")throw new g("\u512A\u5148\u5EA6\u304C\u4E0D\u6B63\u3067\u3059","INVALID_PRIORITY");if(!r.symbol||typeof r.symbol!="string"||r.symbol.trim()==="")throw new g("\u512A\u5148\u5EA6\u306E\u7D75\u6587\u5B57\u304C\u5FC5\u8981\u3067\u3059","INVALID_PRIORITY_SYMBOL");if(!r.label||typeof r.label!="string"||r.label.trim()==="")throw new g("\u512A\u5148\u5EA6\u306E\u30E9\u30D9\u30EB\u304C\u5FC5\u8981\u3067\u3059","INVALID_PRIORITY_LABEL");if(r.label.length>J.maxLabelLength)throw new g("\u512A\u5148\u5EA6\u306E\u30E9\u30D9\u30EB\u306F30\u6587\u5B57\u4EE5\u5185\u3067\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044","PRIORITY_LABEL_TOO_LONG")}validateThought(r){if(!r||typeof r!="object")throw new g("\u601D\u8003\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u304C\u4E0D\u6B63\u3067\u3059","INVALID_THOUGHT");if(!r.id||typeof r.id!="string")throw new g("\u601D\u8003ID\u304C\u4E0D\u6B63\u3067\u3059","INVALID_THOUGHT_ID");if(!r.content||typeof r.content!="string")throw new g("\u601D\u8003\u5185\u5BB9\u304C\u5165\u529B\u3055\u308C\u3066\u3044\u307E\u305B\u3093","EMPTY_THOUGHT_CONTENT");let t=r.content.trim();if(t==="")throw new g("\u601D\u8003\u5185\u5BB9\u304C\u7A7A\u3067\u3059","EMPTY_THOUGHT_CONTENT");if(t.length>J.maxContentLength)throw new g("\u601D\u8003\u5185\u5BB9\u306F100\u6587\u5B57\u4EE5\u5185\u3067\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044","THOUGHT_TOO_LONG");if(!(r.timestamp instanceof Date)||isNaN(r.timestamp.getTime()))throw new g("\u30BF\u30A4\u30E0\u30B9\u30BF\u30F3\u30D7\u304C\u4E0D\u6B63\u3067\u3059","INVALID_TIMESTAMP");if(r.isContinuation&&r.priority!==x.symbol)throw new g("\u4E0D\u6B63\u306A\u7D9A\u304D\u8A2D\u5B9A\u3067\u3059","INVALID_CONTINUATION")}validateFilePath(r){if(!r||typeof r!="string"||r.trim()==="")throw new g("\u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\u304C\u4E0D\u6B63\u3067\u3059","INVALID_FILE_PATH");if(/\.\./.test(r)||/^[\/\\]/.test(r)||/[<>:"|?*]/.test(r))throw new g("\u4E0D\u6B63\u306A\u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\u3067\u3059","DANGEROUS_FILE_PATH")}};function q(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function X(h){let r=h.getFullYear(),t=String(h.getMonth()+1).padStart(2,"0"),e=String(h.getDate()).padStart(2,"0"),i=h.getDay(),s=["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"][i];return`${r}/${t}/${e} (${s})`}function Q(h){let r=String(h.getHours()).padStart(2,"0"),t=String(h.getMinutes()).padStart(2,"0");return`${r}:${t}`}function rt(h){let t=new Date().getTime()-h.getTime(),e=Math.floor(t/(1e3*60)),i=Math.floor(e/60),s=Math.floor(i/24);return e<1?"\u305F\u3063\u305F\u4ECA":e<60?`${e}\u5206\u524D`:i<24?`${i}\u6642\u9593\u524D`:s<7?`${s}\u65E5\u524D`:h.toLocaleDateString("ja-JP")}var M=class extends A.Modal{constructor(t,e,i){super(t);this.isProcessing=!1;this.contentInput=null;this.charCounter=null;this.currentKeyboardHandler=null;this.settings=e,this.callbacks=i,this.thought={id:q(),timestamp:new Date},this.currentStep="priority"}onOpen(){this.modalEl.addClass(b.modal.container),this.contentEl.addClass(b.modal.modal),this.initializeFlow()}onClose(){this.cleanup()}initializeFlow(){switch(this.currentStep){case"priority":this.showPriorityStep();break;case"content":this.showContentStep();break}}showPriorityStep(){this.renderHeader("\u512A\u5148\u5EA6\u3092\u9078\u629E",1,2);let t=this.contentEl.createDiv("priorities-container");this.settings.priorities.forEach((e,i)=>{this.createPriorityButton(t,e,i+1)}),this.createContinuePriorityButton(t),this.setupKeyboardNavigation("priority")}createContinuePriorityButton(t){let e=t.createDiv(`${b.modal.priorityButton} priority-continue`);e.setAttribute("tabindex","0"),e.createSpan({text:x.symbol,cls:"priority-icon"});let i=e.createDiv("priority-text");i.createSpan({text:x.label,cls:"priority-label"}),i.createDiv({text:x.description,cls:"priority-description"}),e.createDiv("shortcut").setText("0"),e.addEventListener("click",()=>this.selectContinue())}selectContinue(){this.thought.priority=x.symbol,this.thought.isContinuation=!0,this.transitionToStep("content")}showContentStep(){this.renderHeader("\u601D\u8003\u3092\u5165\u529B",2,2),this.showSelectionSummary(),this.thought.isContinuation?this.showContinuationHint():this.showPriorityHint(),this.createInputField(),this.createButtons(),this.setupContentKeyboard(),setTimeout(()=>{var t;return(t=this.contentInput)==null?void 0:t.focus()},100)}createPriorityButton(t,e,i){let s=t.createDiv(b.modal.priorityButton);s.setAttribute("tabindex","0"),s.createSpan({text:e.symbol,cls:"priority-icon"});let n=s.createDiv("priority-text");n.createSpan({text:e.label,cls:"priority-label"}),e.description&&n.createDiv({text:e.description,cls:"priority-description"}),s.createDiv("shortcut").setText(`${i}`),s.addEventListener("click",()=>this.selectPriority(e.symbol))}showSelectionSummary(){let t=this.contentEl.createDiv("selection-info");this.thought.priority&&t.createSpan({text:this.thought.priority})}showContinuationHint(){let t=this.contentEl.createDiv("continuation-hint-container");t.createEl("h4",{text:"\u2795 more"}),t.createEl("p",{text:"\u76F4\u524D\u306E\u601D\u8003\u306B\u8FFD\u8A18\u3055\u308C\u307E\u3059\u3002\u95A2\u9023\u3059\u308B\u5185\u5BB9\u3092\u7D9A\u3051\u3066\u8A18\u9332\u3057\u307E\u3057\u3087\u3046\u3002"})}showPriorityHint(){let t=this.thought.priority;if(!t)return;let e=this.settings.priorities.find(s=>s.symbol===t);if(!e||!e.description)return;let i=this.contentEl.createDiv("priority-hint-container");i.createEl("h4",{text:`${t} ${e.label}`}),i.createEl("p",{text:e.description})}createInputField(){let t=this.contentEl.createDiv("input-container");this.contentInput=t.createEl("input",{type:"text",placeholder:"\u601D\u8003\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\uFF08100\u6587\u5B57\u4EE5\u5185\uFF09",cls:b.modal.thoughtInput}),this.contentInput.maxLength=S.maxContentLength,this.charCounter=t.createDiv(b.modal.charCounter),this.updateCharCounter(),this.contentInput.addEventListener("input",()=>{this.updateCharCounter()})}createButtons(){let t=this.contentEl.createDiv("button-container");t.createEl("button",{text:"\u4FDD\u5B58 (Ctrl+Enter)",cls:`${b.modal.saveButton} mod-cta`}).addEventListener("click",()=>this.saveThought()),t.createEl("button",{text:"\u7D9A\u3051\u3066\u601D\u8003 (Alt+Enter)",cls:`${b.modal.saveButton}`}).addEventListener("click",()=>this.continueThought())}async continueThought(){await this.saveThoughtCommon(()=>{this.settings.showNotifications&&new A.Notice("\u601D\u8003\u3092\u4FDD\u5B58\u3057\u307E\u3057\u305F\u3002\u7D9A\u3051\u3066\u5165\u529B\u3067\u304D\u307E\u3059\u3002"),this.thought={id:q(),timestamp:new Date,priority:x.symbol,isContinuation:!0},this.transitionToStep("content")})}async saveThoughtCommon(t){if(!this.contentInput||this.isProcessing)return;let e=this.contentInput.value.trim();if(!e){new A.Notice(m.error.emptyContent);return}try{this.isProcessing=!0,this.thought.content=e,await this.callbacks.onThoughtSaved(this.thought),t()}catch(i){let s=i instanceof Error?i.message:String(i);new A.Notice(`\u601D\u8003\u306E\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F: ${s}`,6e3)}finally{this.isProcessing=!1}}updateCharCounter(){if(!this.charCounter||!this.contentInput)return;let t=this.contentInput.value.length,e=S.maxContentLength;this.charCounter.textContent=`${t}/${e}`,this.charCounter.className=b.modal.charCounter,t>e*.8&&this.charCounter.classList.add("char-counter-warning"),t>=e&&this.charCounter.classList.add("char-counter-error")}setupKeyboardNavigation(t){this.currentKeyboardHandler&&document.removeEventListener("keydown",this.currentKeyboardHandler);let e=i=>{if(!this.modalEl.isConnected)return;if(i.key==="Escape"){this.close();return}let s=i.target;if(s&&(s.tagName==="INPUT"||s.tagName==="TEXTAREA"))return;let n=parseInt(i.key);if(!isNaN(n)){let o=!1;t==="priority"&&n>=0&&n<=9&&(o=!0,n===0?this.selectContinue():n<=this.settings.priorities.length&&this.selectPriority(this.settings.priorities[n-1].symbol)),o&&(i.preventDefault(),i.stopPropagation())}};this.currentKeyboardHandler=e,document.addEventListener("keydown",e)}setupContentKeyboard(){this.currentKeyboardHandler&&(this.contentEl.removeEventListener("keydown",this.currentKeyboardHandler),this.currentKeyboardHandler=null);let t=e=>{e.ctrlKey&&e.key==="Enter"?(e.preventDefault(),this.saveThought()):e.altKey&&e.key==="Enter"?(e.preventDefault(),this.continueThought()):e.key==="Escape"&&this.close()};this.currentKeyboardHandler=t,this.contentEl.addEventListener("keydown",t)}selectPriority(t){this.thought.priority=t,this.transitionToStep("content")}transitionToStep(t){this.cleanup(),this.currentStep=t,this.contentEl.empty(),this.initializeFlow()}async saveThought(){await this.saveThoughtCommon(()=>{if(this.settings.showNotifications){let t=this.thought.isContinuation?m.success.thoughtContinued:m.success.thoughtSaved;new A.Notice(t)}this.close()})}renderHeader(t,e,i){this.contentEl.empty();let s=this.contentEl.createDiv("modal-header");if(s.createEl("h2",{text:t}),e&&i){let n=s.createDiv("modal-progress");n.textContent=`${e}/${i}`}}cleanup(){this.currentKeyboardHandler&&(document.removeEventListener("keydown",this.currentKeyboardHandler),this.currentKeyboardHandler=null)}};var u=require("obsidian");var nt=require("obsidian"),ut=Object.freeze([{name:"\u72B6\u614B\u30FB\u30A2\u30AF\u30B7\u30E7\u30F3",emojis:["\u2705","\u2728","\u{1F525}","\u26A1","\u{1F4A1}","\u{1F331}","\u{1F3AF}","\u{1F4CC}","\u2795","\u2714\uFE0F","\u{1F680}","\u2B50"]},{name:"\u601D\u8003\u30FB\u611F\u60C5",emojis:["\u{1F4AD}","\u2764\uFE0F","\u{1F60A}","\u{1F914}","\u{1F4AA}","\u{1F44D}","\u{1F64F}","\u{1F62E}","\u{1F389}","\u{1F496}"]},{name:"\u4ED5\u4E8B\u30FB\u5B66\u7FD2",emojis:["\u{1F4CB}","\u{1F4DD}","\u{1F4DA}","\u{1F91D}","\u{1F4BC}","\u{1F393}","\u{1F4CA}","\u{1F4BB}","\u{1F58A}\uFE0F","\u{1F4D6}","\u270F\uFE0F","\u{1F4C4}"]},{name:"\u751F\u6D3B",emojis:["\u{1F6D2}","\u{1F3C3}","\u{1F3AE}","\u{1F354}","\u{1F48A}","\u{1F3E0}","\u{1F697}","\u2708\uFE0F","\u{1F3B5}","\u{1F3A8}","\u{1F4F7}","\u26BD"]},{name:"\u8A18\u53F7",emojis:["\u2753","\u2757","\u26A0\uFE0F","\u{1F514}","\u{1F516}","\u{1F4CD}","\u{1F511}","\u{1F381}","\u{1F4AC}","\u{1F4E2}","\u{1F50D}"]}]),H=class extends nt.Modal{constructor(t,e,i){super(t);this.onSelect=e,this.selectedEmoji=i}onOpen(){this.titleEl.setText("\u7D75\u6587\u5B57\u3092\u9078\u629E"),this.contentEl.addClass("emoji-picker-modal");let t=this.contentEl.createDiv({cls:"emoji-picker-container"});ut.forEach(s=>{let n=t.createDiv({cls:"emoji-category"}),o=n.createEl("h3",{text:s.name,cls:"emoji-category-title"});o.style.fontSize="0.9rem",o.style.fontWeight="600",o.style.marginBottom="8px",o.style.color="var(--text-normal)";let d=n.createDiv({cls:"emoji-grid"});d.style.display="grid",d.style.gridTemplateColumns="repeat(auto-fill, minmax(40px, 1fr))",d.style.gap="6px",d.style.marginBottom="20px",s.emojis.forEach(l=>{let a=d.createEl("button",{text:l,cls:"emoji-button"});a.style.fontSize="1.5rem",a.style.padding="8px",a.style.border="2px solid var(--background-modifier-border)",a.style.borderRadius="6px",a.style.background="var(--background-primary)",a.style.cursor="pointer",a.style.transition="all 0.15s ease",this.selectedEmoji===l&&(a.style.borderColor="var(--interactive-accent)",a.style.background="var(--background-modifier-hover)"),a.addEventListener("mouseenter",()=>{this.selectedEmoji!==l&&(a.style.background="var(--background-modifier-hover)",a.style.transform="scale(1.1)")}),a.addEventListener("mouseleave",()=>{this.selectedEmoji!==l&&(a.style.background="var(--background-primary)",a.style.transform="scale(1)")}),a.addEventListener("click",()=>{this.selectedEmoji=l,this.onSelect(l),this.close()})})});let e=this.contentEl.createDiv();e.style.display="flex",e.style.justifyContent="flex-end",e.style.marginTop="20px";let i=e.createEl("button",{text:"\u30AD\u30E3\u30F3\u30BB\u30EB"});i.style.padding="8px 16px",i.addEventListener("click",()=>this.close())}onClose(){this.contentEl.empty()}};var B=class extends u.PluginSettingTab{constructor(t,e,i,s){super(t,e);this.settings=i,this.callbacks=s}display(){this.containerEl.empty(),this.containerEl.addClass("abyss-settings"),this.renderPriorityManagement(),this.renderUISettings(),this.renderStatistics(),this.renderDebug()}renderPriorityManagement(){let t=this.createSection("\u512A\u5148\u5EA6\u7BA1\u7406","\u601D\u8003\u30AD\u30E3\u30D7\u30C1\u30E3\u6642\u306B\u4F7F\u7528\u3059\u308B\u512A\u5148\u5EA6\u3092\u7BA1\u7406\u3057\u307E\u3059\u3002");if(new u.Setting(t).setName("\u512A\u5148\u5EA6\u30D7\u30EA\u30BB\u30C3\u30C8").setDesc("\u4F7F\u7528\u3059\u308B\u512A\u5148\u5EA6\u30BB\u30C3\u30C8\u3092\u9078\u629E").addDropdown(e=>{E.forEach(i=>{e.addOption(i.id,i.name)}),e.addOption("custom","\u30AB\u30B9\u30BF\u30E0"),e.setValue(this.settings.selectedPreset).onChange(async i=>{if(this.settings.selectedPreset=i,i!=="custom"){let s=E.find(n=>n.id===i);s&&(this.settings.priorities=[...s.priorities])}await this.saveSettings(),this.display()})}),this.settings.selectedPreset!=="custom"){let e=E.find(i=>i.id===this.settings.selectedPreset);if(e){let i=t.createDiv({cls:"preset-description"});i.style.marginBottom="15px",i.style.padding="10px",i.style.background="var(--background-secondary)",i.style.borderRadius="4px",i.style.fontSize="0.875rem",i.textContent=e.description}}this.settings.selectedPreset==="custom"?this.renderCustomPriorities(t):this.renderPriorityPreview(t)}renderPriorityPreview(t){let e=t.createDiv({cls:"priorities-preview"});e.style.marginTop="15px";let i=e.createEl("h4",{text:"\u73FE\u5728\u306E\u512A\u5148\u5EA6"});i.style.marginBottom="10px";let s=e.createDiv({cls:"priorities-list"});this.settings.priorities.forEach(n=>{let d=s.createDiv({cls:"priority-item"}).createDiv({cls:"priority-info"}),l=d.createSpan({text:n.symbol,cls:"priority-symbol"});l.style.fontSize="1.5rem";let a=d.createSpan({text:n.label,cls:"priority-label"});if(a.style.fontWeight="600",a.style.marginLeft="10px",n.description){let p=d.createSpan({text:n.description,cls:"priority-desc"});p.style.fontSize="0.875rem",p.style.color="var(--text-muted)",p.style.marginLeft="10px"}})}renderCustomPriorities(t){let e=t.createDiv("priorities-list");if(this.settings.priorities.length===0){let s=t.createDiv();s.style.marginBottom="15px",s.style.padding="10px",s.style.color="var(--text-muted)",s.style.fontSize="0.875rem",s.textContent="\u512A\u5148\u5EA6\u304C\u767B\u9332\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002"}else this.settings.priorities.forEach((s,n)=>{this.renderPriorityItem(e,s,n)});let i=this.settings.priorities.length>=S.maxCustomPriorities;new u.Setting(t).setName("\u512A\u5148\u5EA6\u3092\u8FFD\u52A0").setDesc(i?`\u6700\u5927${S.maxCustomPriorities}\u3064\u307E\u3067\u767B\u9332\u3067\u304D\u307E\u3059`:"").addButton(s=>s.setButtonText("\u65B0\u898F\u8FFD\u52A0").setCta().setDisabled(i).onClick(()=>this.showAddPriorityDialog())),this.settings.priorities.length>1&&new u.Setting(t).setName("\u30D7\u30EA\u30BB\u30C3\u30C8\u306B\u30EA\u30BB\u30C3\u30C8").setDesc("\u30B9\u30BF\u30F3\u30C0\u30FC\u30C9\u30D7\u30EA\u30BB\u30C3\u30C8\u306B\u623B\u3057\u307E\u3059").addButton(s=>{s.setButtonText("\u30EA\u30BB\u30C3\u30C8").onClick(async()=>{await this.showConfirm("\u30EA\u30BB\u30C3\u30C8\u78BA\u8A8D","\u512A\u5148\u5EA6\u3092\u30B9\u30BF\u30F3\u30C0\u30FC\u30C9\u30D7\u30EA\u30BB\u30C3\u30C8\u306B\u623B\u3057\u307E\u3059\u304B\uFF1F")&&(this.settings.priorities=[...E[0].priorities],await this.saveSettings(),this.display(),new u.Notice("\u512A\u5148\u5EA6\u3092\u30EA\u30BB\u30C3\u30C8\u3057\u307E\u3057\u305F"))}),s.buttonEl.addClass("abyss-warning-btn")})}renderPriorityItem(t,e,i){let s=t.createDiv("priority-item");s.setAttribute("draggable","true"),s.dataset.index=String(i);let n=s.createDiv("priority-drag-handle");n.textContent="\u283F";let o=s.createDiv("priority-info"),d=o.createSpan({text:e.symbol,cls:"priority-symbol"});d.style.fontSize="1.5rem";let l=o.createSpan({text:e.label,cls:"priority-label"});if(l.style.fontWeight="600",l.style.marginLeft="10px",e.description){let c=o.createSpan({text:e.description,cls:"priority-desc"});c.style.fontSize="0.875rem",c.style.color="var(--text-muted)",c.style.marginLeft="10px"}let a=s.createDiv("priority-actions");a.createEl("button",{text:"\u7DE8\u96C6"}).addEventListener("click",()=>this.showEditPriorityDialog(e,i)),this.settings.priorities.length>1&&a.createEl("button",{text:"\u524A\u9664",cls:"abyss-delete-btn"}).addEventListener("click",()=>this.deletePriority(i)),s.addEventListener("dragstart",c=>{var v;s.addClass("dragging"),(v=c.dataTransfer)==null||v.setData("text/plain",String(i)),c.dataTransfer&&(c.dataTransfer.effectAllowed="move")}),s.addEventListener("dragend",()=>{s.removeClass("dragging"),t.querySelectorAll(".priority-item").forEach(c=>{c.removeClass("drag-over-top"),c.removeClass("drag-over-bottom")})}),s.addEventListener("dragover",c=>{c.preventDefault(),c.dataTransfer&&(c.dataTransfer.dropEffect="move");let v=s.getBoundingClientRect(),T=v.top+v.height/2;t.querySelectorAll(".priority-item").forEach(y=>{y.removeClass("drag-over-top"),y.removeClass("drag-over-bottom")}),c.clientY<T?s.addClass("drag-over-top"):s.addClass("drag-over-bottom")}),s.addEventListener("dragleave",()=>{s.removeClass("drag-over-top"),s.removeClass("drag-over-bottom")}),s.addEventListener("drop",async c=>{var y;c.preventDefault();let v=Number((y=c.dataTransfer)==null?void 0:y.getData("text/plain")),T=i;if(v!==T&&!isNaN(v)){let[C]=this.settings.priorities.splice(v,1);this.settings.priorities.splice(T,0,C),await this.saveSettings(),this.display()}})}showAddPriorityDialog(){if(this.settings.priorities.length>=S.maxCustomPriorities){new u.Notice("\u30AB\u30B9\u30BF\u30E0\u512A\u5148\u5EA6\u306F\u6700\u59278\u3064\u307E\u3067\u3067\u3059");return}new j(this.app,"\u65B0\u3057\u3044\u512A\u5148\u5EA6\u3092\u8FFD\u52A0",void 0,async t=>{if(this.settings.priorities.some(i=>i.symbol===t.symbol||i.label.toLowerCase()===t.label.toLowerCase()))throw new Error("\u540C\u3058\u7D75\u6587\u5B57\u307E\u305F\u306F\u30E9\u30D9\u30EB\u306E\u512A\u5148\u5EA6\u304C\u65E2\u306B\u5B58\u5728\u3057\u307E\u3059");this.settings.priorities.push(t),await this.saveSettings(),this.display(),new u.Notice(m.success.priorityAdded)}).open()}showEditPriorityDialog(t,e){new j(this.app,"\u512A\u5148\u5EA6\u3092\u7DE8\u96C6",t,async i=>{if(this.settings.priorities.some((n,o)=>o!==e&&(n.symbol===i.symbol||n.label.toLowerCase()===i.label.toLowerCase())))throw new Error("\u540C\u3058\u7D75\u6587\u5B57\u307E\u305F\u306F\u30E9\u30D9\u30EB\u306E\u512A\u5148\u5EA6\u304C\u65E2\u306B\u5B58\u5728\u3057\u307E\u3059");this.settings.priorities[e]=i,await this.saveSettings(),this.display(),new u.Notice("\u512A\u5148\u5EA6\u3092\u66F4\u65B0\u3057\u307E\u3057\u305F")}).open()}async deletePriority(t){let e=this.settings.priorities[t];await this.showConfirm("\u524A\u9664\u78BA\u8A8D",`\u300C${e.label}\u300D\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F`)&&(this.settings.priorities.splice(t,1),await this.saveSettings(),this.display(),new u.Notice(m.success.priorityDeleted))}renderUISettings(){let t=this.createSection("UI\u8A2D\u5B9A","\u30E6\u30FC\u30B6\u30FC\u30A4\u30F3\u30BF\u30FC\u30D5\u30A7\u30FC\u30B9\u306E\u52D5\u4F5C\u3092\u8A2D\u5B9A\u3067\u304D\u307E\u3059\u3002");new u.Setting(t).setName("\u901A\u77E5\u3092\u8868\u793A").setDesc("\u601D\u8003\u3092\u4FDD\u5B58\u3057\u305F\u3068\u304D\u306B\u901A\u77E5\u3092\u8868\u793A\u3059\u308B").addToggle(e=>e.setValue(this.settings.showNotifications).onChange(async i=>{this.settings.showNotifications=i,await this.saveSettings()})),new u.Setting(t).setName("\u601D\u8003\u5F8C\u306B Advent log \u3092\u81EA\u52D5\u3067\u958B\u304F").setDesc("\u601D\u8003\u3092\u30AD\u30E3\u30D7\u30C1\u30E3\u3057\u305F\u5F8C\u3001\u81EA\u52D5\u7684\u306B Advent log \u3092\u958B\u304F").addToggle(e=>e.setValue(this.settings.autoOpenAdventLog).onChange(async i=>{this.settings.autoOpenAdventLog=i,await this.saveSettings()})),new u.Setting(t).setName("\u30A2\u30FC\u30AB\u30A4\u30D6\u6642\u306B done \u30ED\u30B0\u3092\u6B8B\u3059").setDesc("Advent view \u3067\u30A2\u30FC\u30AB\u30A4\u30D6\u3059\u308B\u969B\u3001done \u30ED\u30B0\u3068\u3057\u3066\u8A18\u9332\u3059\u308B").addToggle(e=>e.setValue(this.settings.logArchiveAsDone).onChange(async i=>{this.settings.logArchiveAsDone=i,await this.saveSettings(),this.display()})),this.settings.logArchiveAsDone&&new u.Setting(t).setName("done \u30ED\u30B0\u30C6\u30F3\u30D7\u30EC\u30FC\u30C8").setDesc("\u30D7\u30EC\u30FC\u30B9\u30DB\u30EB\u30C0\u30FC: {emoji} = \u7D75\u6587\u5B57, {content} = \u30ED\u30B0\u5185\u5BB9").addText(e=>e.setPlaceholder("[{emoji} {content}] was archived.").setValue(this.settings.doneLogTemplate).onChange(async i=>{this.settings.doneLogTemplate=i,await this.saveSettings()}))}renderStatistics(){let t=this.createSection("\u4F7F\u7528\u7D71\u8A08","\u30D7\u30E9\u30B0\u30A4\u30F3\u306E\u4F7F\u7528\u72B6\u6CC1\u3068\u7D71\u8A08\u60C5\u5831\u3092\u8868\u793A\u3057\u307E\u3059\u3002");this.loadAndDisplayStats(t)}async loadAndDisplayStats(t){let e=t.createDiv({text:"\u7D71\u8A08\u60C5\u5831\u3092\u8AAD\u307F\u8FBC\u307F\u4E2D..."});try{let i=await this.callbacks.getStats();e.remove();let s=t.createDiv("stats-grid");if(this.createStatCard(s,i.totalThoughts.toString(),"\u7DCF\u601D\u8003\u6570"),this.createStatCard(s,i.averageThoughtsPerDay.toString(),"1\u65E5\u5E73\u5747\u601D\u8003\u6570"),i.lastThoughtDate){let n=rt(i.lastThoughtDate);this.createStatCard(s,n,"\u6700\u5F8C\u306E\u601D\u8003\u8A18\u9332")}}catch(i){e.textContent="\u7D71\u8A08\u60C5\u5831\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"}}createStatCard(t,e,i){let s=t.createDiv("stat-card");s.createDiv({text:e,cls:"stat-value"}),s.createDiv({text:i,cls:"stat-label"})}renderDebug(){let t=this.createSection("\u30C7\u30D0\u30C3\u30B0\u60C5\u5831","\u30B7\u30B9\u30C6\u30E0\u306E\u554F\u984C\u3092\u8A3A\u65AD\u3059\u308B\u305F\u3081\u306E\u60C5\u5831\u3067\u3059\u3002");new u.Setting(t).setName("\u8A2D\u5B9A\u60C5\u5831\u3092\u8868\u793A").addButton(e=>e.setButtonText("\u8A2D\u5B9A\u3092\u8868\u793A").onClick(()=>this.showDebugInfo()))}showDebugInfo(){let t=new u.Modal(this.app);t.titleEl.setText("\u30C7\u30D0\u30C3\u30B0\u60C5\u5831");let e={version:"1.5.0",settings:this.settings,timestamp:new Date().toISOString()},i=t.contentEl.createEl("pre");i.textContent=JSON.stringify(e,null,2),i.style.fontSize="12px",i.style.maxHeight="400px",i.style.overflow="auto",t.open()}createSection(t,e){let i=this.containerEl.createDiv("abyss-settings-section");return i.createEl("h2",{text:t}),e&&i.createEl("p",{text:e}),i}async saveSettings(){try{await this.callbacks.saveSettings()}catch(t){this.handleError("\u8A2D\u5B9A\u306E\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F",t)}}async showConfirm(t,e){return new Promise(i=>{let s=new u.Modal(this.app);s.titleEl.setText(t),s.contentEl.createEl("p",{text:e});let n=s.contentEl.createDiv();n.style.display="flex",n.style.gap="10px",n.style.justifyContent="flex-end",n.createEl("button",{text:"\u30AD\u30E3\u30F3\u30BB\u30EB"}).addEventListener("click",()=>{s.close(),i(!1)}),n.createEl("button",{text:"\u5B9F\u884C",cls:"mod-warning"}).addEventListener("click",()=>{s.close(),i(!0)}),s.open()})}handleError(t,e){let i=e instanceof Error?e.message:String(e);new u.Notice(`${t}: ${i}`,6e3)}},j=class extends u.Modal{constructor(t,e,i,s){super(t);this.title=e,this.originalPriority=i,this.onSave=s,this.priority=i?{...i}:{symbol:"",label:"",description:"",showInAdventView:!0}}onOpen(){this.titleEl.setText(this.title);let t=this.contentEl.createDiv();this.createEmojiSelector(t);let e=this.createField(t,"\u30E9\u30D9\u30EB",this.priority.label,d=>{this.priority.label=d});e.placeholder="\u4F8B: todo";let i=this.createField(t,"\u8AAC\u660E\uFF08\u4EFB\u610F\uFF09",this.priority.description,d=>{this.priority.description=d});i.placeholder="\u4F8B: \u3084\u308B\u3053\u3068",this.createShowInAdventViewCheckbox(t);let s=t.createDiv();s.style.display="flex",s.style.gap="10px",s.style.justifyContent="flex-end",s.style.marginTop="20px",s.createEl("button",{text:"\u30AD\u30E3\u30F3\u30BB\u30EB"}).addEventListener("click",()=>this.close()),s.createEl("button",{text:this.originalPriority?"\u66F4\u65B0":"\u8FFD\u52A0",cls:"mod-cta"}).addEventListener("click",()=>this.handleSave()),setTimeout(()=>e.focus(),100)}createEmojiSelector(t){let e=t.createDiv();e.style.marginBottom="15px",e.createEl("label",{text:"\u7D75\u6587\u5B57"});let i=e.createDiv();i.style.display="flex",i.style.alignItems="center",i.style.gap="10px",i.style.marginTop="5px";let s=i.createEl("span",{text:this.priority.symbol||"\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044",cls:"emoji-preview"});s.style.fontSize="2rem",s.style.minWidth="50px",s.style.textAlign="center";let n=i.createEl("button",{text:"\u7D75\u6587\u5B57\u3092\u9078\u629E",cls:"mod-cta"});n.style.padding="8px 16px",n.addEventListener("click",()=>{new H(this.app,o=>{this.priority.symbol=o,s.textContent=o},this.priority.symbol).open()})}createField(t,e,i,s){let n=t.createDiv();n.style.marginBottom="15px",n.createEl("label",{text:e});let o=n.createEl("input",{type:"text",value:i});return o.style.width="100%",o.style.marginTop="5px",o.style.padding="8px",o.style.fontSize="14px",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px",o.addEventListener("input",()=>s(o.value)),o}createShowInAdventViewCheckbox(t){var o;let e=t.createDiv();e.style.marginBottom="15px";let i=e.createDiv();i.style.display="flex",i.style.alignItems="center",i.style.gap="8px";let s=i.createEl("input",{type:"checkbox"});s.checked=(o=this.priority.showInAdventView)!=null?o:!0,s.addEventListener("change",()=>{this.priority.showInAdventView=s.checked});let n=i.createEl("label",{text:"Advent view \u306B\u8868\u793A"});n.style.cursor="pointer",n.addEventListener("click",()=>{s.checked=!s.checked,this.priority.showInAdventView=s.checked})}async handleSave(){if(!this.priority.symbol.trim()){new u.Notice("\u7D75\u6587\u5B57\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}if(!this.priority.label.trim()){new u.Notice("\u30E9\u30D9\u30EB\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044");return}try{await this.onSave(this.priority),this.close()}catch(t){let e=t instanceof Error?t.message:String(t);new u.Notice(`\u64CD\u4F5C\u306B\u5931\u6557\u3057\u307E\u3057\u305F: ${e}`)}}};var ot=require("obsidian");var O=class{constructor(r,t,e){this.app=r,this.vault=r.vault,this.settings=t,this.logger=e,this.validator=new k}async initializeFolders(){try{return await this.waitForVaultReady(),await this.createFolders(),P()}catch(r){let t=r instanceof g?r:new g(m.error.folderCreation,"FOLDER_INIT_FAILED");return this.logger.logError(t,"initializeFolders"),F(t.message)}}async waitForVaultReady(){let t=Date.now();return new Promise((e,i)=>{let s=()=>{if(Date.now()-t>1e4){i(new g("Vault initialization timeout","VAULT_TIMEOUT"));return}this.vault.adapter?setTimeout(e,100):setTimeout(s,50)};s()})}async createFolders(){for(let r of st)await this.createFolderIfNotExists(r)}async createFolderIfNotExists(r){try{this.validator.validateFilePath(r);let t=r.replace(/\\/g,"/");this.vault.getAbstractFileByPath(t)||(await this.vault.createFolder(t),this.logger.debug(`Created folder: ${t}`))}catch(t){if(t instanceof Error&&t.message.includes("already exists"))return;throw new g(`Failed to create folder ${r}`,"FOLDER_CREATE_FAILED")}}async saveThought(r){try{this.validator.validateThought(r);let t=await this.getOrCreateThoughtLogFile(),e=await this.vault.read(t);e=this.updateHeaderPriorityList(e),e=this.ensureAdventViewLink(e);let i;return r.isContinuation?i=this.appendToLastThought(e,r):i=this.insertThoughtIntoContent(e,r),await this.vault.modify(t,i),this.logger.info("Thought saved successfully",{thoughtId:r.id,isContinuation:r.isContinuation}),P()}catch(t){let e=t instanceof g?t:new g(m.error.fileSave,"THOUGHT_SAVE_FAILED");return this.logger.logError(e,"saveThought"),F(e.message)}}ensureAdventViewLink(r){let t=this.generatePriorityListText(),e="[\u{1F4CB} Advent view](obsidian://abyss-open-advent-view)",i=`# Advent log

${t}
${e}

---`,s=r.split(`
`),n=-1;for(let c=0;c<s.length;c++)if(s[c].startsWith("---")){n=c;break}if(n===-1)return i+`
`+r;let o=s.slice(0,n),d=this.generatePriorityListText(),l=o.some(c=>c===d),a=o.some(c=>c.includes(e));if(!(o.length>=4&&o[0]==="# Advent log"&&o[1]===""&&l&&a)){let c=s.slice(n+1);return i+`
`+c.join(`
`)}return r}appendToLastThought(r,t){let e=r.split(`
`),i=this.findHeaderEndIndex(e);for(let s=i;s<e.length;s++)if(this.isThoughtLine(e[s])){let n=s+1;for(;n<e.length&&e[n].trim()!==""&&(e[n].startsWith("  ")||e[n].startsWith("	"));)n++;return e.splice(n,0,`  \u2795 ${t.content}`),e.join(`
`)}throw new g(m.error.noPreviousThought,"NO_PREVIOUS_THOUGHT")}isThoughtLine(r){return O.THOUGHT_LINE_PATTERN.test(r)}async getOrCreateThoughtLogFile(){let r=L,t=this.vault.getAbstractFileByPath(r);if(!t){let e=this.generateInitialFileContent();t=await this.vault.create(r,e)}if(!(t instanceof ot.TFile))throw new g("Failed to create Advent log file","ADVENT_LOG_FILE_ERROR");return t}insertThoughtIntoContent(r,t){let i=`## ${X(t.timestamp)}`,n=`${Q(t.timestamp)} ${t.priority} ${t.content}`,o=r.split(`
`),d=o.findIndex(l=>l===i);if(d!==-1){let l=d+1;for(;l<o.length&&o[l].trim()==="";)l++;return o.splice(l,0,n),o.join(`
`)}else{let l=this.findHeaderEndIndex(o),a=-1;for(let p=l;p<o.length;p++)if(o[p].startsWith("## ")){a=p;break}return a!==-1?o.splice(a,0,i,"",n,""):o.splice(l,0,"",i,"",n),o.join(`
`)}}findHeaderEndIndex(r){for(let t=0;t<r.length;t++)if(r[t].startsWith("---"))return t+1;return 0}generateInitialFileContent(){return`# Advent log

${this.generatePriorityListText()}
[\u{1F4CB} Advent view](obsidian://abyss-open-advent-view)

---
  `}generatePriorityListText(){return`${this.settings.priorities.map(t=>`${t.symbol}${t.label}`).join(" ")} \u2795more`}updateHeaderPriorityList(r){let t=r.split(`
`),e=this.generatePriorityListText(),i=this.findHeaderEndIndex(t);for(let s=0;s<i;s++)if(O.EMOJI_PATTERN.test(t[s])&&!t[s].startsWith("[")&&!t[s].startsWith("#")){t[s]=e;break}return t.join(`
`)}async getStats(){try{let r=await this.getOrCreateThoughtLogFile(),t=await this.vault.read(r),e=new RegExp(O.THOUGHT_LINE_PATTERN.source,"gm"),i=t.match(e)||[],s=new RegExp(O.DATE_SECTION_PATTERN.source,"gm"),n=t.match(s)||[],o=r.stat.mtime>0?new Date(r.stat.mtime):void 0,d=n.length>0?Number((i.length/n.length).toFixed(1)):0;return{totalLogFiles:1,totalThoughts:i.length,lastThoughtDate:o,averageThoughtsPerDay:d}}catch(r){return this.logger.error("Failed to get stats:",r),{totalLogFiles:0,totalThoughts:0,averageThoughtsPerDay:0}}}updateSettings(r){this.settings=r}async archiveThought(r){try{let t=await this.getOrCreateThoughtLogFile(),i=(await this.vault.read(t)).split(`
`);if(r<0||r>=i.length)throw new g("Invalid line number","INVALID_LINE_NUMBER");let s=i[r];return s.includes("[done]")?P():(i[r]=`${s} [done]`,await this.vault.modify(t,i.join(`
`)),this.logger.info("Thought archived successfully",{lineNumber:r}),P())}catch(t){let e=t instanceof g?t:new g("Failed to archive thought","ARCHIVE_FAILED");return this.logger.logError(e,"archiveThought"),F(e.message)}}async addDoneLog(r){try{if(!this.settings.logArchiveAsDone)return P();let t=it,e=new Date,i=X(e),s=Q(e),o=(this.settings.doneLogTemplate||"[{emoji} {content}] was archived.").replace("{emoji}",r.symbol).replace("{content}",r.content),d={id:`done-${Date.now()}`,content:o,priority:t,timestamp:e},l=await this.getOrCreateThoughtLogFile(),a=await this.vault.read(l);a=this.updateHeaderPriorityList(a);let p=this.insertThoughtIntoContent(a,d);return await this.vault.modify(l,p),this.logger.info("Done log added successfully"),P()}catch(t){let e=t instanceof g?t:new g("Failed to add done log","DONE_LOG_FAILED");return this.logger.logError(e,"addDoneLog"),F(e.message)}}},D=O;D.THOUGHT_LINE_PATTERN=/^\d{2}:\d{2}\s+[^\x00-\x7F]/,D.EMOJI_PATTERN=/[^\x00-\x7F]/,D.DATE_SECTION_PATTERN=/^## \d{4}\/\d{2}\/\d{2}/;var _=require("obsidian");var $=class{parseAdventLog(r,t){let e=r.split(`
`),i=[],s="",n=0;for(let o=0;o<e.length;o++){let d=e[o];n=o;let l=d.match(/^## (\d{4}\/\d{2}\/\d{2})/);if(l){s=l[1];continue}let a=d.match(/^(\d{2}:\d{2})\s+([^\x00-\x7F]+)\s+(.+)$/);if(a&&s){let p=a[1],c=a[2],v=a[3],T=v.includes("[done]");v=v.replace(/\s*\[done\]\s*$/,"").trim();let y=[],C=o+1;for(;C<e.length;){let Z=e[C],tt=Z.match(/^\s+âž•\s+(.+)$/);if(tt)y.push(tt[1]),C++;else if(Z.trim()==="")C++;else break}i.push({time:p,date:s,symbol:c,content:v,continuations:y,isDone:T,rawLine:d,lineNumber:n}),o=C-1}}return i}filterByCategory(r,t){return r.filter(e=>e.symbol===t&&!e.isDone)}filterByShowInAdventView(r,t){let e=t.filter(i=>i.showInAdventView!==!1).map(i=>i.symbol);return r.filter(i=>e.includes(i.symbol)&&!i.isDone)}};var N="abyss-advent-view-side",V="abyss-advent-view-main",U=class{constructor(r,t,e){this.currentCategory=null;this.thoughts=[];this.app=r,this.settings=t,this.parser=new $,this.fileManager=e}async loadThoughts(){let r=this.app.vault.getAbstractFileByPath(L);if(r instanceof _.TFile){let t=await this.app.vault.read(r);this.thoughts=this.parser.parseAdventLog(t,this.settings.priorities)}else this.thoughts=[];this.currentCategory===null&&(this.currentCategory=this.getDefaultCategory())}getDefaultCategory(){let r=this.getVisibleCategories();if(r.length===0)return null;for(let t of r)if(this.parser.filterByCategory(this.thoughts,t.symbol).length>0)return t.symbol;return r[0].symbol}getVisibleCategories(){return this.settings.priorities.filter(r=>r.showInAdventView!==!1)}getFilteredThoughts(){return this.currentCategory===U.ALL_CATEGORY?this.parser.filterByShowInAdventView(this.thoughts,this.settings.priorities):this.currentCategory?this.parser.filterByCategory(this.thoughts,this.currentCategory):this.parser.filterByShowInAdventView(this.thoughts,this.settings.priorities)}isAllCategorySelected(){return this.currentCategory===U.ALL_CATEGORY}async archiveThought(r){await this.loadThoughts();let t=this.thoughts.find(e=>e.time===r.time&&e.date===r.date&&e.content===r.content&&e.symbol===r.symbol&&!e.isDone);t&&(await this.fileManager.archiveThought(t.lineNumber),await this.fileManager.addDoneLog(t),await this.loadThoughts())}renderThoughtItem(r,t,e,i,s=!1){let n=r.createDiv("advent-thought-item"),o=n.createEl("input",{type:"checkbox"});o.classList.add("advent-checkbox");let d=n.createDiv("advent-thought-content"),l=d.createDiv("advent-thought-main");if(l.style.cursor="pointer",s?(l.createSpan({text:t.symbol,cls:"advent-thought-emoji"}),l.appendText(` ${t.content}`)):l.textContent=t.content,l.addEventListener("click",async()=>{let v=this.app.vault.getAbstractFileByPath(L);v instanceof _.TFile&&await this.app.workspace.getLeaf().openFile(v,{eState:{line:t.lineNumber}})}),t.continuations.length>0){let v=d.createDiv("advent-continuations");t.continuations.forEach(T=>{let y=v.createDiv("advent-continuation-item");y.textContent=`\u2192 ${T}`})}let a=d.createDiv("advent-thought-meta");a.textContent=`${t.date} ${t.time}`;let p=e?"\u{1F4C1} \u30A2\u30FC\u30AB\u30A4\u30D6":"\u{1F4C1}",c=n.createEl("button",{text:p,cls:"advent-archive-btn"});e||(c.title="\u30A2\u30FC\u30AB\u30A4\u30D6"),c.addEventListener("click",i),o.addEventListener("change",()=>{o.checked?n.addClass("checked"):n.removeClass("checked")})}},w=U;w.ALL_CATEGORY="__all__";var z=class extends _.ItemView{constructor(t,e,i){super(t);this.settings=e,this.fileManager=i,this.core=new w(this.app,e,i)}getViewType(){return N}getDisplayText(){return"Advent view"}getIcon(){return"list-todo"}async onOpen(){await this.core.loadThoughts(),this.render()}async onClose(){}render(){let t=this.containerEl.children[1];t.empty(),t.addClass("advent-view-container"),t.addClass("advent-view-side");let e=t.createDiv("advent-view-header");e.createEl("h4",{text:"Advent view"});let i=e.createDiv("advent-header-btns"),s=i.createEl("button",{text:"ALL",cls:"advent-all-btn"});this.core.currentCategory===w.ALL_CATEGORY&&s.addClass("active"),s.addEventListener("click",async()=>{this.core.currentCategory=w.ALL_CATEGORY,await this.core.loadThoughts(),this.render()}),i.createEl("button",{text:"\u{1F504}",cls:"advent-refresh-btn"}).addEventListener("click",async()=>{await this.core.loadThoughts(),this.render()});let o=t.createDiv("advent-category-tabs");this.core.getVisibleCategories().forEach(p=>{let c=o.createEl("button",{text:`${p.symbol}`,cls:"advent-category-tab"});this.core.currentCategory===p.symbol&&c.addClass("active"),c.addEventListener("click",async()=>{this.core.currentCategory=p.symbol,await this.core.loadThoughts(),this.render()})});let l=t.createDiv("advent-thought-list"),a=this.core.getFilteredThoughts();a.length===0?l.createDiv({text:"\u30A2\u30A4\u30C6\u30E0\u306F\u3042\u308A\u307E\u305B\u3093",cls:"advent-empty-message"}):a.forEach(p=>{this.core.renderThoughtItem(l,p,!1,async()=>{await this.core.archiveThought(p),this.render()},this.core.isAllCategorySelected())})}async refresh(){await this.core.loadThoughts(),this.render()}},G=class extends _.ItemView{constructor(t,e,i){super(t);this.settings=e,this.fileManager=i,this.core=new w(this.app,e,i)}getViewType(){return V}getDisplayText(){return"Advent view"}getIcon(){return"list-todo"}async onOpen(){await this.core.loadThoughts(),this.render()}async onClose(){}render(){let t=this.containerEl.children[1];t.empty(),t.addClass("advent-view-container"),t.addClass("advent-view-main");let e=t.createDiv("advent-view-header");e.createEl("h2",{text:"Advent view"});let i=e.createDiv("advent-header-btns"),s=i.createEl("button",{text:"ALL",cls:"advent-all-btn"});this.core.currentCategory===w.ALL_CATEGORY&&s.addClass("active"),s.addEventListener("click",async()=>{this.core.currentCategory=w.ALL_CATEGORY,await this.core.loadThoughts(),this.render()}),i.createEl("button",{text:"\u{1F504} \u66F4\u65B0",cls:"advent-refresh-btn"}).addEventListener("click",async()=>{await this.core.loadThoughts(),this.render()});let o=t.createDiv("advent-category-tabs");this.core.getVisibleCategories().forEach(p=>{let c=o.createEl("button",{text:`${p.symbol} ${p.label}`,cls:"advent-category-tab"});this.core.currentCategory===p.symbol&&c.addClass("active"),c.addEventListener("click",async()=>{this.core.currentCategory=p.symbol,await this.core.loadThoughts(),this.render()})});let l=t.createDiv("advent-thought-list"),a=this.core.getFilteredThoughts();a.length===0?l.createDiv({text:"\u30A2\u30A4\u30C6\u30E0\u306F\u3042\u308A\u307E\u305B\u3093",cls:"advent-empty-message"}):a.forEach(p=>{this.core.renderThoughtItem(l,p,!0,async()=>{await this.core.archiveThought(p),this.render()},this.core.isAllCategorySelected())})}async refresh(){await this.core.loadThoughts(),this.render()}};var Y=class extends I.Plugin{async onload(){this.logger=new R(et.name),this.validator=new k;try{await this.initializePlugin(),await this.migrateFromV15(),this.logger.info("Plugin loaded successfully")}catch(t){this.handleError("Plugin initialization failed",t)}}async migrateFromV15(){let t=this.settings;(t.contextPrefixes||t.recentContexts||t.showContextSelection!==void 0)&&(this.logger.info("Migrating from v1.5..."),delete t.contextPrefixes,delete t.recentContexts,delete t.showContextSelection,this.settings.selectedPreset||(this.settings.selectedPreset="standard"),(!this.settings.priorities||this.settings.priorities.length===0)&&(this.settings.priorities=[...E[0].priorities]),await this.saveSettings(),this.logger.info("Migration completed"),new I.Notice(`Abyss v1.2\u306B\u30A2\u30C3\u30D7\u30C7\u30FC\u30C8\u3057\u307E\u3057\u305F\uFF01
\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u6A5F\u80FD\u304C\u524A\u9664\u3055\u308C\u3001\u3088\u308A\u30B7\u30F3\u30D7\u30EB\u306B\u306A\u308A\u307E\u3057\u305F\u3002`,8e3))}onunload(){this.logger.info("Plugin unloaded")}async initializePlugin(){await this.loadSettings(),this.fileManager=new D(this.app,this.settings,this.logger),this.registerViews(),this.registerCommands(),this.registerUI(),this.registerSettingTab(),this.registerURIHandlers(),await this.initializeFolders()}registerViews(){this.registerView(N,t=>new z(t,this.settings,this.fileManager)),this.registerView(V,t=>new G(t,this.settings,this.fileManager))}registerURIHandlers(){this.registerObsidianProtocolHandler("abyss-open-advent-view",async()=>{await this.activateAdventViewSide()})}async activateAdventViewSide(){let{workspace:t}=this.app,e=null,i=t.getLeavesOfType(N);if(i.length>0)e=i[0];else{let s=t.getRightLeaf(!1);s&&(e=s,await e.setViewState({type:N,active:!0}))}e&&t.revealLeaf(e)}async activateAdventViewMain(){let{workspace:t}=this.app,e=null,i=t.getLeavesOfType(V);i.length>0?e=i[0]:(e=t.getLeaf("tab"),await e.setViewState({type:V,active:!0})),e&&t.revealLeaf(e)}async loadSettings(){try{let t=await this.loadData();this.settings=this.validator.validateSettings(t)}catch(t){this.logger.error("Failed to load settings, using defaults:",t),this.settings={...f}}}async saveSettings(){var t;try{let e=this.validator.validateSettings(this.settings);await this.saveData(e),this.settings=e,(t=this.fileManager)==null||t.updateSettings(e)}catch(e){throw this.logger.error("Failed to save settings:",e),new g(m.error.settingsLoad,"SETTINGS_SAVE_FAILED")}}registerCommands(){this.addCommand({id:"capture-thought",name:"\u601D\u8003\u3092\u30AD\u30E3\u30D7\u30C1\u30E3",callback:()=>this.openCaptureModal(),hotkeys:[{modifiers:W.capture.modifiers,key:W.capture.key}]}),this.addCommand({id:"open-advent-view-main",name:"Advent view \u3092\u958B\u304F",callback:()=>this.activateAdventViewMain()}),this.addCommand({id:"open-advent-view-side",name:"Advent view \u3092\u30B5\u30A4\u30C9\u30D0\u30FC\u3067\u958B\u304F",callback:()=>this.activateAdventViewSide()})}registerUI(){this.addRibbonIcon("brain","\u601D\u8003\u3092\u30AD\u30E3\u30D7\u30C1\u30E3",()=>this.openCaptureModal()),this.addRibbonIcon("list-todo","Advent view \u3092\u958B\u304F",()=>this.activateAdventViewMain())}registerSettingTab(){this.addSettingTab(new B(this.app,this,this.settings,{saveSettings:()=>this.saveSettings(),initializeFolders:()=>this.fileManager.initializeFolders(),getStats:()=>this.fileManager.getStats()}))}async initializeFolders(){if(!this.settings.foldersInitialized)try{(await this.fileManager.initializeFolders()).success&&(this.settings.foldersInitialized=!0,await this.saveSettings())}catch(t){this.logger.error("Folder initialization error:",t)}}openCaptureModal(){try{new M(this.app,this.settings,{onThoughtSaved:e=>this.saveThought(e)}).open()}catch(t){this.handleError("Failed to open capture modal",t)}}async saveThought(t){try{this.validator.validateThought(t);let e=await this.fileManager.saveThought(t);if(!e.success)throw new g(e.error||"Unknown error occurred","THOUGHT_SAVE_FAILED");if(await this.saveSettings(),this.logger.info("Thought saved successfully",{thoughtId:t.id}),this.settings.autoOpenAdventLog){let i=this.app.vault.getAbstractFileByPath(L);i instanceof I.TFile&&await this.app.workspace.getLeaf().openFile(i)}}catch(e){throw this.logger.error("Failed to save thought:",e),e}}handleError(t,e){let i=e instanceof Error?e.message:String(e),s=`${t}: ${i}`;this.logger.error(s),new I.Notice(s,5e3)}async reinitializeFolders(){this.settings.foldersInitialized=!1,(await this.fileManager.initializeFolders()).success&&(this.settings.foldersInitialized=!0,await this.saveSettings())}};0&&(module.exports={});
